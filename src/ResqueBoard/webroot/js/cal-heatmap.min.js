var CalHeatMap=function(){function t(t){var n=r[i.options.subDomain].position.x(t);return n*i.options.cellsize+n*i.options.cellpadding}function n(t){var n=r[i.options.subDomain].position.y(t);return n*i.options.cellsize+n*i.options.cellpadding}function e(t){u.each(function(n){d3.select(this).selectAll("rect").attr("class",function(e){var o=r[i.options.subDomain].extractUnit(e);return"graph-rect"+(t.hasOwnProperty(n)&&t[n].hasOwnProperty(o)?" "+i.scale(t[n][o]):"")}).on("click",function(e){var o=r[i.options.subDomain].extractUnit(e);return i.onClick(e,t.hasOwnProperty(n)&&t[n].hasOwnProperty(o)?t[n][o]:0)}).select("title").text(function(e){var o=r[i.options.subDomain].extractUnit(e);return(t.hasOwnProperty(n)&&t[n].hasOwnProperty(o)?s(t[n][o])+" "+i.options.itemName[t[n][o]>1?1:0]+" "+r[i.options.subDomain].format.connector+" ":"")+a(e)})})}function o(t){var n={};for(var e in t){var o=new Date(1e3*e),a=i.getDomain(o)[0];a=a.getTime();var s=r[i.options.subDomain].extractUnit(o);n[a]===void 0&&(n[a]={}),n[a][s]!==void 0?n[a][s]+=t[e]:n[a][s]=t[e]}return n}var i=this;this.options={id:"cal-heatmap",scales:[10,20,30,40],range:12,cellsize:10,cellpadding:2,format:{date:null,legend:null},onClick:function(){},displayScale:!0,itemName:["item","items"],start:new Date,uri:"",loadOnInit:!0,domain:"hour",subDomain:"min"};var a,r={min:{row:10,column:function(){return 6},position:{x:function(t){return Math.floor(t.getMinutes()/r.min.row)},y:function(t){return t.getMinutes()%r.min.row}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit:function(t){return t.getMinutes()}},hour:{row:6,column:function(t){return 4*("month"===i.options.domain?i.getEndOfMonth(t).getDate():1)},position:{x:function(t){return"month"===i.options.domain?Math.floor(t.getHours()/r.hour.row)+4*(t.getDate()-1):Math.floor(t.getHours()/r.hour.row)},y:function(t){return t.getHours()%r.hour.row}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit:function(t){return"hour"===i.options.subDomain?t.getHours()+""+i.getDayOfYear(t):t.getHours()}},day:{row:7,column:function(){return"year"===i.options.domain?55:5},position:{x:function(t){return Math.floor(("year"===i.options.domain?i.getDayOfYear(t):t.getDate())/r.day.row)},y:function(t){return("year"===i.options.domain?i.getDayOfYear(t):t.getDate())%r.day.row}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit:function(t){return i.getDayOfYear(t)}},week:{format:{date:"",legend:""}},month:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getMonth()/r.month.row)},y:function(t){return t.getMonth()%r.month.row}},format:{date:"%B %Y",legend:"%B",connector:"on"},extractUnit:function(t){return t.getMonth()}},year:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getFullYear()/r.year.row)},y:function(t){return t.getFullYear()%r.year.row}},format:{date:"%Y",legend:"%Y",connector:"on"},extractUnit:function(t){return t.getFullYear()}}},s=d3.format(",d"),u=null,l=null,c=function(){var s=2*i.options.cellsize;a=d3.time.format(i.options.format.date);var c=function(t){return i.options.cellsize*r[i.options.subDomain].column(t)+i.options.cellpadding*r[i.options.subDomain].column(t)+i.options.cellpadding},p=i.options.cellsize*r[i.options.subDomain].row+i.options.cellpadding*r[i.options.subDomain].row+i.options.cellpadding,g=d3.time.format(i.options.format.legend);return u=d3.select("#"+i.options.id).append("div").attr("class","graph").selectAll().data(i.getDomain(i.options.start).map(function(t){return t.getTime()})).enter().append("div").attr("class","hour").style("width",function(t){return c(t)+"px"}).style("height",p+s+"px").style("display","inline-block").append("svg:svg").attr("width",function(t){return c(t)}).attr("height",p+s).append("svg:g").attr("transform","translate(0, 1)"),u.append("svg:text").attr("y",p+s/1.5).attr("class","graph-label").attr("text-anchor","middle").attr("vertical-align","middle").attr("x",function(t){return c(t)/2}).text(function(t){return g(new Date(t))}),l=u.selectAll("rect").data(function(t){return i.getSubDomain(t)}).enter().append("svg:rect").attr("class","graph-rect").attr("width",i.options.cellsize).attr("height",i.options.cellsize).attr("x",function(n){return t(n)}).attr("y",function(t){return n(t)}),l.append("svg:title").text(function(t){return a(t)}),i.options.displayScale&&i.displayScale(),i.options.loadOnInit&&d3.json(i.options.uri,function(t){e(o(t))}),!0};this.init=function(t){if(null!==t&&void 0!==t&&"undefined"!==t)for(var n in i.options)null!==t[n]&&void 0!==t[n]&&"undefined"!==t[n]&&(i.options[n]=t[n]);if(!r.hasOwnProperty(i.options.domain)||"min"===i.options.domain)return console.log("The domain name is not valid"),!1;var e=i.getDomain(i.options.start);return""===i.options.uri&&(i.options.uri="/api/scheduled-jobs/stats/"+parseInt(i.options.start.getTime()/1e3,10)+"/"+parseInt(e[e.length-1].getTime()/1e3,10)),null===i.options.format.date&&(i.options.format.date=r[i.options.subDomain].format.date),null===i.options.format.legend&&(i.options.format.legend=r[i.options.domain].format.legend),c()}};CalHeatMap.prototype={onClick:function(t,n){return this.options.onClick(t,n)},displayScale:function(){var t=this;d3.select("#"+this.options.id).append("svg:svg").attr("class","graph-scale").attr("height",this.options.cellsize+2*this.options.cellpadding).selectAll().data(d3.range(0,this.options.scales.length+1)).enter().append("svg:rect").attr("width",this.options.cellsize).attr("height",this.options.cellsize).attr("class",function(t){return"graph-rect q"+(t+1)}).attr("transform",function(n){return"translate("+n*(t.options.cellsize+t.options.cellpadding)+", "+t.options.cellpadding+")"}).append("svg:title").text(function(n){return t.options.scales[n+1],0===n?"less than "+t.options.scales[n]+" "+t.options.itemName[1]:n===t.options.scales.length?"more than "+t.options.scales[n-1]+" "+t.options.itemName[1]:"between "+t.options.scales[n-1]+" and "+t.options.scales[n]+" "+t.options.itemName[1]})},getDayOfYear:d3.time.format("%j"),getEndOfMonth:function(t){return"number"==typeof t&&(t=new Date(t)),new Date(t.getFullYear(),t.getMonth(),0)},getWeekDomain:function(t,n){var e;return 1===t.getDay()?e=new Date(t.getFullYear(),t.getMonth(),t.getDate()):(e=d3.time.monday(t),e.setDate(t.getDate()-7)),d3.time.mondays(e,new Date(e.getTime()+6048e5*n))},getYearDomain:function(t,n){return d3.time.years(new Date(t.getFullYear(),0),new Date(t.getFullYear()+n,0))},getMinuteDomain:function(t,n){var e=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return d3.time.minutes(e,new Date(e.getTime()+36e5*n))},getHourDomain:function(t,n){var e=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return"number"==typeof n&&(n=new Date(e.getTime()+36e5*n)),d3.time.hours(e,n)},getDayDomain:function(t,n){var e=new Date(t.getFullYear(),t.getMonth(),t.getDate());return d3.time.days(e,new Date(e.getTime()+864e5*n))},getMonthDomain:function(t,n){var e=new Date(t.getFullYear(),t.getMonth()),o=new Date(e);return o=o.setMonth(o.getMonth()+n),d3.time.months(e,o)},getDomain:function(t){switch("number"==typeof t&&(t=new Date(t)),this.options.domain){case"hour":return this.getHourDomain(t,this.options.range);case"day":return this.getDayDomain(t,this.options.range);case"week":return this.getWeekDomain(t,this.options.range);case"month":return this.getMonthDomain(t,this.options.range);case"year":return this.getYearDomain(t,this.options.range)}},getSubDomain:function(t){switch("number"==typeof t&&(t=new Date(t)),this.options.subDomain){case"min":return this.getMinuteDomain(t,1);case"hour":return this.getHourDomain(t,"month"===this.options.domain?new Date(t.getFullYear(),t.getMonth()+1):24);case"day":return this.getDayDomain(t,"year"===this.options.domain?365:30);case"week":return this.getWeekDomain(t,1);case"month":return this.getMonthDomain(t,12)}},scale:function(t){for(var n=0,e=this.options.scales.length-1;e>n;n++)if(this.options.scales[n]>=t)return"q"+(n+1);return 0===t?"":"q"+this.options.scales.length}};