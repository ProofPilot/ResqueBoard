/**
 * ResqueBoard Javascript File
 *
 * Make all the numbers on the screen blink
 *
 * Licensed under The MIT License
 * Redistributions of files must retain the above copyright notice.
 *
 * @author		Wan Qi Chen <kami@kamisama.me>
 * @copyright	Copyright 2012, Wan Qi Chen <kami@kamisama.me>
 * @link		http://resqueboard.kamisama.me
 * @since		1.0.0
 * @license		MIT License (http://www.opensource.org/licenses/mit-license.ctp)
 *//*jshint

	curly: true,
	eqeqeq: true,
	noarg: true,
	noempty: true,
	undef: true,
	quotmark: "double",
	boss: true,
	regexdash: true,
	browser: true,
	devel: true,
	wsh: true,
	trailing: true,
	jquery: true,
	loopfunc:true

*//*global require:true, hljs:true, d3:true, serverIp:true, moment:true, cubism:true, infinity:true */function listenToJobsActivities(){var e=25;d3.json("http://"+serverIp+":1081/1.0/metric/get"+"?expression=sum(got)"+"&start=2012-07-07T16:00:00Z"+"&stop="+formatISO(stop)+"&limit="+e+"&step="+step[0].code,function(t){function S(){l.domain([t[0].time,f(t[t.length-1].time)]),c.domain([0,d3.max(t.map(function(e){return e.value}))]);var e=p.selectAll("rect").data(t,function(e){return e.time}),n=p.selectAll("text").data(t,function(e){return e.time});e.enter().insert("rect").call(d).attr("x",function(e,t){return l(f(e.time))}).attr("clip-path","url(#clip)").transition().duration(duration).attr("x",function(e){return l(e.time)+o+2}),e.transition().duration(duration).attr("clip-path","url(#clip)").call(v),e.exit().transition().duration(duration).attr("x",function(e,t){return l(e.time)+u}).remove(),n.enter().insert("text").call(m).attr("x",function(e){return l(f(f(e.time)))-o/2}).transition().duration(duration).attr("x",function(e){return l(e.time)+o/2}),n.transition().duration(duration).call(g),n.exit().transition().duration(duration).attr("x",function(e){return l(e.time)+o/2}).remove(),w.transition().duration(duration).call(y),E.transition().duration(duration).call(b)}var n={top:25,right:35,bottom:35,left:20},r=620-n.right-n.left,i=180-n.top-n.bottom,s=i,o=r/e-2,u=0,a=20,f=function(e){return e=new Date(e),new Date(e.setSeconds(e.getSeconds()+step[0].second))};t=t.map(function(e){return{time:new Date(e.time),value:e.value}}).slice(0,e);var l=d3.time.scale().domain([t[0].time,f(t[t.length-1].time)]).range([0,r]),c=d3.scale.linear().domain([0,d3.max(t.map(function(e){return e.value}))]).rangeRound([i,0]),h=d3.select("#lastest-jobs").append("svg").attr("class","chart").attr("width",r+n.left+n.right).attr("height",i+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");h.append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",r).attr("height",i),h.append("svg:text").attr("x",r).attr("y",-5).attr("text-anchor","end").text("jobs/10sec").attr("class","axis-legend"),h.append("svg:text").attr("x",r/2).attr("y",i+a+10).attr("text-anchor","middle").text("time (min:sec)").attr("class","axis-legend");var p=h.append("svg").attr("clip-path","url(#clip)").attr("class","bar-area"),d=function(e){e.attr("title",function(e){return e.value}).attr("data-target","#job-details-modal").on("click",function(e){displayJobsModal(e.time)}).call(v)},v=function(e){e.attr("x",function(e){return l(e.time)+u}).attr("y",function(e){return c(e.value)}).attr("width",o).attr("height",function(e){return i-c(e.value)})};p.selectAll("rect").data(t).enter().append("rect").call(d);var m=function(e){e.attr("text-anchor","middle").attr("class",function(e){return i-c(e.value)<=a?"bar-label out":"bar-label"}).text(function(e){return e.value}).call(g)},g=function(e){e.attr("y",function(e){return i-c(e.value)>a?c(e.value):c(e.value)-a}).attr("dy","1.5em").attr("x",function(e){return l(e.time)+o/2})};p.selectAll("text").data(t).enter().append("text").attr("x",function(e){return l(e.time)+o/2}).call(m);var y=d3.svg.axis().scale(l).ticks(d3.time.seconds,30).tickFormat(d3.time.format("%M:%S")).tickSubdivide(2).tickSize(6,3,0).orient("bottom"),b=d3.svg.axis().scale(c).tickSize(6,3,0).orient("right").ticks(4),w=h.append("g").attr("transform","translate(0,"+i+")").attr("class","x-axis").call(y),E=h.append("g").attr("class","y-axis").attr("transform","translate("+r+",0)").call(b),x=new WebSocket("ws://"+serverIp+":1081/1.0/metric/get");x.onopen=function(){var e=f(t[t.length-1].time);x.send(JSON.stringify({expression:"sum(got)",start:e.toISOString(),stop:f(e).toISOString(),limit:1,step:step[0].code}))},x.onmessage=function(e){var n=JSON.parse(e.data);n.hasOwnProperty("value")&&(n.time=new Date(n.time),t.shift(),t.push(n),S(),setTimeout(function(){var e=f(t[t.length-1].time);x.send(JSON.stringify({expression:"sum(got)",start:e.toISOString(),stop:f(e).toISOString(),limit:1,step:step[0].code}))},step[0].second*1e3))}})}function displayJobsModal(e){var t=Date.parse(e)/1e3,n=$("#job-details").data("timestamp");n!==t?$.ajax({url:"/api/jobs/"+t+"/"+(t+step[0].second),success:function(e){$("#job-details .modal-body").html($("#jobs-tpl").render(e)),$("#job-details").data("timestamp",t),$("#job-details .modal-header .badge").html(e.length),$("#job-details").modal("show")}}):$("#job-details-modal").modal("show")}function loadLogs(){function v(t,s){$("input[data-rel="+l[s.data.level].name+"]").is(":checked")&&(n.append($("#log-template").render(h(t,s))),e.verbosity.hasOwnProperty(l[s.data.level].name)||r("verbosity",l[s.data.level].name,$("#log-sweeper-form span[data-rel="+l[s.data.level].name+"]")),e.type.hasOwnProperty([t])||r("type",t,$("#log-sweeper-form span[data-rel="+t+"]")),i("verbosity",l[s.data.level].name,1),i("type",t,1),i("general","g",1),$("#log-area").find("time").each(function(){$(this).html(moment($(this).attr("title")).fromNow()).tooltip()}))}function m(e){var t=new WebSocket("ws://"+serverIp+":1081/1.0/event/get");t.onopen=function(){t.send(JSON.stringify({expression:a[e].expression,start:formatISO(stop)}))},t.onmessage=function(t){v(e,JSON.parse(t.data))}}var e={general:{g:$("[data-rel=log-counter]")},type:{},verbosity:{}},t=$("#log-area"),n=new infinity.ListView(t),r=function(t,n,r){e[t][n]=r},i=function(t,n,r){var i=e[t][n];i.html(parseInteger(i.html())+r),i.queue("fx").length===0&&i.effect("highlight")},s=function(t,n,r){var i=e[t][n],s=parseInteger(i.html());s-r>=0&&(i.html(s-r),i.queue("fx").length===0&&i.effect("highlight"))},o=function(e){e.each(function(){var e=$(this);s("type",e.data("type"),1),s("verbosity",e.data("verbosity"),1),s("general","g",1)})},u=function(){for(var t in e)if(e.hasOwnProperty(t))for(var n in e[t])e[t].hasOwnProperty(n)&&e[t][n].html(0)},a={sleep:{expression:"sleep",format:function(e){return"for "+e.second+" seconds"}},got:{expression:"got",format:function(e){return"job #"+e.args.payload.id}},process:{expression:"process",format:function(e){return"job #"+e.job_id}},fork:{expression:"fork",format:function(e){return"job #"+e.job_id}},done:{expression:"done",format:function(e){return"job #"+e.job_id}},fail:{expression:"fail",format:function(e){return"job #"+e.job_id}},start:{expression:"start",format:function(e){return"worker #"+e.worker}},stop:{expression:"shutdown",format:function(e){return"worker #"+e.worker}}};for(var f in a)a.hasOwnProperty(f)&&m(f);var l={100:{name:"debug",classStyle:"label-success"},200:{name:"info",classStyle:"label-info"},300:{name:"warning",classStyle:"label-warning"},400:{name:"error",classStyle:"label-important"},500:{name:"critical",classStyle:"label-inverse"},550:{name:"alert",classStyle:"label-inverse"}},c={},h=function(e,t){return{time:t.time,relativeTime:moment(t.time).fromNow(),action:e,levelName:l[t.data.level].name,levelClass:l[t.data.level].classStyle,detail:a[e].format(t.data),worker:t.data.worker,workerClass:t.data.worker.replace(new RegExp("(\\.|:)","gm"),""),color:p(t)}},p=function(e){return c[e.data.worker]===undefined&&(c[e.data.worker]=d[Object.keys(c).length]),c[e.data.worker]},d=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d #","17becf","#9edae5"];$("#clear-log-area").on("click",function(){$("#log-area").children().remove(),u()}),$("#log-filter-form").on("change","input",function(e){var t=$(this).data("rel");$("#log-area").append('<li class="filter-event"><b>'+($(this).is(":checked")?"Start":"Stop")+"</b> listening to <em>"+t+"</em> events</li>");var n=$.cookie("ResqueBoard.mutedLevel",{path:"/logs"});n=n.split(",");if($(this).is(":checked")){var r=n.indexOf(t);r!==-1&&n.splice(r,1)}else n[n.length]=t;$.cookie("ResqueBoard.mutedLevel",n.join(","),{expires:365,path:"/logs"})}),$("#log-sweeper-form").on("click","button[data-rel=verbosity]",function(e){var t=n.find($("li[data-verbosity="+$(this).data("level")+"]"));for(var r=0,i=t.length;r<i;r++)t[r].remove();return!1}),$("#log-sweeper-form").on("click","button[data-rel=type]",function(e){var t=$("#log-area").children("li[data-type="+$(this).data("type")+"]");return o(t),t.remove(),!1}),$("#log-area").on("mouseenter","li",function(){$("#log-area li[data-worker="+$(this).data("worker")+"]").addClass("hover-highlight")}),$("#log-area").on("mouseleave","li",function(){$("#log-area li[data-worker="+$(this).data("worker")+"]").removeClass("hover-highlight")})}function listenToWorkersJob(e){function i(e){var t=new WebSocket("ws://"+serverIp+":1081/1.0/event/get");t.onopen=function(){t.send(JSON.stringify({expression:n[e].expression,start:formatISO(stop)}))},t.onmessage=function(t){s(e,JSON.parse(t.data))}}function s(e,n){switch(e){case"done":t.processDone(n);break;case"fail":t.processFail(n)}}var t=function(){var e=function(e){return e.data.worker};return{processDone:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)},processGot:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)},processFail:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)}}}(),n={done:{expression:"done",format:function(e){return"job #"+e.job_id}},fail:{expression:"fail",format:function(e){return"job #"+e.job_id}}};for(var r in n)i(r);Job.initJobsChart(e)}function listenToWorkersActivities(){var e=cubism.context().size(466),t=e.cube("http://"+serverIp+":1081"),n=e.horizon().metric(t.metric).height(53),r=e.rule(),i=[],s=[];$(".worker-stats h4").each(function(e){i.push($(this).html())});if(i.length===0)return;for(var o=0,u=i.length;o<u;o++)s.push('sum(done.eq(worker, "'+i[o]+'"))');d3.select("#worker-activities").append("div").attr("class","rule").call(e.rule()),d3.select("#worker-activities").selectAll(".horizon").data(s).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select("#worker-activities").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}function parseInteger(e){return+e.replace(",","")}function number_format(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function pieChart(e,t,n,r){var i=0,s=80,o=40,u=14,a=d3.scale.category20(),f=d3.layout.pie().value(function(e){return e.count}),l=$("#"+e),c=l.width(),h=250,p=d3.svg.arc().startAngle(function(e){return e.startAngle}).endAngle(function(e){return e.endAngle}).innerRadius(o).outerRadius(s),d=function(e){return e>1e4?Math.round(e/1e3)+"K":e},v=d3.select(l[0]).append("svg:svg").attr("class","classyPieChart").attr("width",c).attr("height",h),m=v.append("svg:g").attr("transform","translate("+c/2+","+h/2+")"),g=v.append("svg:g").attr("transform","translate("+c/2+","+h/2+")"),y=v.append("svg:g").attr("transform","translate("+c/2+","+h/2+")");m.selectAll("path").data(f(n)).enter().append("svg:path").attr("d",p).attr("stroke","white").attr("stroke-width",.5).attr("fill",function(e,t){return a(t)}).each(function(e,t){n[t].startAngle=e.startAngle,n[t].endAngle=e.endAngle});if(n.length===0)var b=m.append("svg:circle").attr("fill","#EFEFEF").attr("r",s),w=y.append("svg:circle").attr("fill","white").attr("r",o);var E=y.append("svg:text").attr("class","pie-label").attr("dy",-15).attr("text-anchor","middle").text("TOTAL"),S=y.append("svg:text").attr("class","pie-total").attr("dy",7).attr("text-anchor","middle").text(d(t)),x=y.append("svg:text").attr("class","pie-units").attr("dy",21).attr("text-anchor","middle").text("jobs"),T=g.selectAll("line").data(n);T.enter().append("svg:line").attr("x1",0).attr("x2",0).attr("y1",-s-3).attr("y2",-s-8).attr("stroke","gray").attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"});var N=g.selectAll("text.pie-value").data(n).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?5:-7}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).enter().append("svg:text").attr("class","pie-value").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(s+u)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(s+u)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?5:-7}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.count+"%"}),C=g.selectAll("text.pie-units").data(n).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:5}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.name});C.enter().append("svg:text").attr("class","pie-units").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(s+u)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(s+u)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:5}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.name})}function jobsLoad(){var e=cubism.context().size($("#jobs-load").width()),t=e.cube("http://"+serverIp+":1081"),n=e.horizon().metric(t.metric).height(100),r=e.rule(),i=[],s=[];s.push("sum(got)"),d3.select("#jobs-load").append("div").attr("class","rule").call(e.rule()),d3.select("#jobs-load").selectAll(".horizon").data(s).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select("#jobs-load").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}function monthlyJobsLoad(e){var t=function(t,n,r){d3.json("http://"+serverIp+":1081/1.0/metric/get"+"?expression=sum(got)"+"&start="+t+"&stop="+n+"&step="+step[4].code,function(t){t=t.map(function(e){return{time:new Date(e.time),value:e.value}});var n=$("#jobs-load-monthly").width(),i=$("#jobs-load-monthly").height(),s=20,o=5,u=35,a=45,f=d3.time.scale().domain([t[0].time,t[t.length-1].time]).range([0,n-a-o]),l=d3.scale.linear().domain([0,Math.max(d3.max(t.map(function(e){return e.value})),e)*1.25]).range([i-s-u,0]);d3.select("#jobs-load-monthly").selectAll("svg").remove();var c=d3.select("#jobs-load-monthly").append("svg").attr("width",n).attr("height",i),h=d3.svg.line().x(function(e){return f(e.time)}).y(function(e){return l(e.value)}),p=d3.svg.area().x(function(e){return f(e.time)}).y0(i-u-s).y1(function(e){return l(e.value)}),d=d3.svg.axis().scale(f).tickFormat(d3.time.format("%d")).tickSubdivide(1).orient("bottom"),v=d3.svg.axis().scale(l).tickSize(-n+a+o).ticks(8).orient("left");c.append("g").attr("class","x-axis").attr("transform","translate("+a+","+(i-u)+")").call(d),c.append("g").attr("class","y-axis").attr("transform","translate("+(a-1)+","+s+")").call(v);var m=c.append("g").attr("width",n-a+o).attr("height",i-s+u).attr("transform","translate("+a+","+s+")");m.append("rect").attr("x",0).attr("y",l(e)).attr("width",n-a-o).attr("height",i-l(e)-u-s).attr("class","graph-average-area"),m.append("path").attr("class","graph-line").attr("d",h(t)),m.append("path").attr("class","graph-area").attr("d",p(t)),c.append("text").attr("x",n/2).attr("y",i-3).attr("text-anchor","middle").text(r).attr("class","graph-title"),c.append("text").attr("x",a/2).attr("y",10).attr("text-anchor","left").text("Jobs/days").attr("class","graph-legend"),c.append("text").attr("x",n-o).attr("y",10).attr("text-anchor","end").text("Average : "+number_format(e)+" jobs/day").attr("class","graph-legend")})},n=function(){var e=$("#jobs-load-monthly-selector option:selected"),n=moment(e.val()+"-01","YYYY-MM-DD"),r=moment(n).add("M",1);t(n.format("YYYY-MM-DD"),r.format("YYYY-MM-DD"),e.text())};n(),$("#jobs-load-monthly-selector").on("change",function(e){n()})}$("[data-event~=tooltip]").tooltip(),$("[data-event~=collapse-all]").on("click",function(e){e.preventDefault(),$(".collapse.in").collapse("hide")}),$("[data-event~=expand-all]").on("click",function(e){e.preventDefault(),$(".collapse").not(".in").collapse("show")}),$("[data-event~=ajax-pagination]").on("change","select",function(e){window.location=$(this).val()}),hljs.initHighlightingOnLoad();var stop=new Date(Date.now()),formatISO=function(e){var t=d3.time.format.iso;return t.parse(e)},duration=1500,step=new Array({second:10,code:"1e4"},{second:60,code:"6e4"},{second:300,code:"3e5"},{second:3600,code:"36e5"},{second:84600,code:"864e5"}),Job=function(){var e=0,t=0,n={};return{initJobsChart:function(r){if($(".worker-stats").length!==0){var i=function(e){if($("#"+e).length===0)return!1;var t=$("#"+e),n=t.find("[data-status=processed]"),r=t.find("[data-status=failed]");return{processedJobsCountDOM:n,failedJobsCountDOM:r,processedJobsCount:parseInteger(n.html()),failedJobsCount:parseInteger(r.html()),chart:t.find("[data-type=chart]")}};$(".worker-stats").each(function(t){var r=$(this),i=r.find("[data-status=processed]"),s=r.find("[data-status=failed]"),o=parseInteger(i.html()),u=r.find("[data-type=chart]");n[r.attr("id")]={processedJobsCountDOM:i,processedJobsCount:o,failedJobsCountDOM:s,failedJobsCount:parseInteger(s.html()),chart:u,chartType:u.data("chart-type")},e+=o}),n["global-worker-stats"]=i("global-worker-stats"),n["active-worker-stats"]=i("active-worker-stats"),t=1,r==="pie"&&jobPieChart.init(n)}else t=2},updateJobsChart:function(r,i){if(t===2)return;n[r].processedJobsCount++,e++,i===400&&n[r].failedJobsCount++;var s=function(e,t){var r="processedJobsCount";t||(r="failedJobsCount"),n[e][r+"DOM"].html(number_format(n[e][r])),n[e][r+"DOM"].queue("fx").length===0&&n[e][r+"DOM"].effect("highlight")};i===400&&s(r,!1),s(r,!0),n["active-worker-stats"]!==!1&&(n["active-worker-stats"].processedJobsCount++,s("active-worker-stats",!0),i===400&&(n["active-worker-stats"].failedJobsCount++,s("active-worker-stats",!1))),n["global-worker-stats"]!==!1&&(n["global-worker-stats"].processedJobsCount++,s("global-worker-stats",!0),i===400&&(n["global-worker-stats"].failedJobsCount++,s("global-worker-stats",!1)));switch(n[r].chartType){case"pie":jobPieChart.redraw(n[r],!0),jobPieChart.redraw(n["active-worker-stats"],!1),jobPieChart.redraw(n["global-worker-stats"],!1);break;case"horizontal-bar":for(var o=0,u=n.length;o<u;o++)n[o]!==!1&&n[o].chart.animate({width:Math.floor(n[o].processedJobsCount/e*100)+"%"},500)}}}}(),jobPieChart=function(){var e=function(e){var t=e.processedJobsCount-e.failedJobsCount,n=[{name:"success",count:t===0&&e.failedJobsCount===0?1:t,color:"#aec7e8"},{name:"failed",count:e.failedJobsCount,color:"#e7969c"}];return n},t=0,n=d3.scale.category20c(),r=d3.layout.pie().value(function(e){return e.count});return{init:function(n){for(var i in n)if(n.hasOwnProperty(i)){var s=e(n[i]),o=n[i].chart,u=(o.width()-t*2)/2,a=d3.svg.arc().innerRadius(u/2).outerRadius(u),f=d3.select(o[0]).append("svg:svg").attr("width",(u+t)*2).attr("height",(u+t)*2).append("svg:g").attr("transform","translate("+(u+t)+","+(u+t)+")");f.selectAll("path").data(r(s)).enter().append("svg:path").attr("d",a).attr("fill",function(e){return e.data.color}).attr("title",function(e){return e.data.count+" "+e.data.name+" jobs"}).each(function(e){this._current=e})}},redraw:function(n){function a(e){var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return u(t(e))}}var i=e(n),s=n.chart,o=(s.width()-t*2)/2,u=d3.svg.arc().innerRadius(o/2).outerRadius(o);d3.select(s[0]).select("svg").selectAll("path").data(r(i)).transition().duration(duration).attrTween("d",a)}}}();