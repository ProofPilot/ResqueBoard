function listenToJobsActivities(){var t=80;d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent("2012-07-07T16:00:00Z")+"&stop="+encodeURIComponent(formatISO(stop))+"&limit="+t+"&step="+step[0].code,function(e){function a(){d.domain([e[0].time,c(e[e.length-1].time)]),u.domain([0,d3.max(e.map(function(t){return t.value}))]);var t=f.selectAll("rect").data(e,function(t){return t.time});t.enter().insert("rect").call(g).attr("x",function(t){return d(c(t.time))}).attr("clip-path","url(#clip)").transition().duration(duration).attr("x",function(t){return d(t.time)+s+2}),t.transition().duration(duration).attr("clip-path","url(#clip)").call(h),t.exit().transition().duration(duration).attr("x",function(t){return d(t.time)+i}).remove(),b.transition().duration(duration).call(m),w.transition().duration(duration).call(v)}if(null===e)return displayCubeNoFoundError();var r={top:25,right:35,bottom:35,left:20},n=860-r.right-r.left,o=180-r.top-r.bottom,s=n/t-2,i=0,l=20,c=function(t){return t=new Date(t),new Date(t.setSeconds(t.getSeconds()+step[0].second))};e=e.map(function(t){return{time:new Date(t.time),value:t.value}}).slice(0,t);var d=d3.time.scale().domain([e[0].time,c(e[e.length-1].time)]).range([0,n]),u=d3.scale.linear().domain([0,d3.max(e.map(function(t){return t.value}))]).rangeRound([o,0]),p=d3.select("#lastest-jobs").append("svg").attr("class","chart").attr("width",n+r.left+r.right).attr("height",o+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")");p.append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",n).attr("height",o),p.append("svg:text").attr("x",n).attr("y",-5).attr("text-anchor","end").text("jobs/10sec").attr("class","axis-legend"),p.append("svg:text").attr("x",n/2).attr("y",o+l+10).attr("text-anchor","middle").text("time").attr("class","axis-legend");var f=p.append("svg").attr("clip-path","url(#clip)").attr("class","bar-area"),g=function(t){t.attr("title",function(t){return t.value}).attr("data-target",".modal").on("click",function(t){displayJobsModal(t.time)}).call(h)},h=function(t){t.attr("x",function(t){return d(t.time)+i}).attr("y",function(t){return u(t.value)}).attr("width",s).attr("height",function(t){return o-u(t.value)})};f.selectAll("rect").data(e).enter().append("rect").call(g);var m=d3.svg.axis().scale(d).tickSubdivide(2).tickSize(6,3,0).orient("bottom"),v=d3.svg.axis().scale(u).tickSize(6,3,0).orient("right").ticks(4),b=p.append("g").attr("transform","translate(0,"+o+")").attr("class","x-axis").call(m),w=p.append("g").attr("class","y-axis").attr("transform","translate("+n+",0)").call(v),k=new WebSocket("ws://"+CUBE_URL+"/1.0/metric/get");k.onopen=function(){var t=c(e[e.length-1].time);k.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:c(t).toISOString(),limit:1,step:step[0].code}))},k.onmessage=function(t){var r=JSON.parse(t.data);r.hasOwnProperty("value")&&(r.time=new Date(r.time),e.shift(),e.push(r),a(),setTimeout(function(){var t=c(e[e.length-1].time);k.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:c(t).toISOString(),limit:1,step:step[0].code}))},1e3*step[0].second))}})}function displayJobsModal(t){var e=Date.parse(t)/1e3,a=$("#job-details").data("timestamp");a!==e?$.ajax({url:"/api/jobs/"+encodeURIComponent(e)+"/"+encodeURIComponent(e+step[0].second),success:function(t){$("#job-details .modal-body").html($("#jobs-tpl").render(t)),$("#job-details").data("timestamp",e),$("#job-details .modal-header .badge").html(t.length),$("#job-details").modal("show")}}):$("#job-details-modal").modal("show")}function loadLogs(){function t(t,e){$("input[data-rel="+d[e.data.level].name+"]").is(":checked")&&($("#log-area").append($("#log-template").render(p(t,e))),a.verbosity.hasOwnProperty(d[e.data.level].name)||r("verbosity",d[e.data.level].name,$("#log-sweeper-form span[data-rel="+d[e.data.level].name+"]")),a.type.hasOwnProperty([t])||r("type",t,$("#log-sweeper-form span[data-rel="+t+"]")),n("verbosity",d[e.data.level].name,1),n("type",t,1),n("general","g",1))}function e(e){var a=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get");a.onopen=function(){a.send(JSON.stringify({expression:l[e].expression,start:formatISO(stop)}))},a.onmessage=function(a){t(e,JSON.parse(a.data))}}var a={general:{g:$("[data-rel=log-counter]")},type:{},verbosity:{}},r=function(t,e,r){a[t][e]=r},n=function(t,e,r){var n=a[t][e];n.html(parseInteger(n.html())+r)},o=function(t,e,r){var n=a[t][e],o=parseInteger(n.html());o-r>=0&&(n.html(o-r),fireEffect(n,"highlight"))},s=function(t){t.each(function(){var t=$(this);o("type",t.data("type"),1),o("verbosity",t.data("verbosity"),1),o("general","g",1)})},i=function(){for(var t in a)if(a.hasOwnProperty(t))for(var e in a[t])a[t].hasOwnProperty(e)&&a[t][e].html(0)},l={sleep:{expression:"sleep",format:function(t){return"for "+t.second+" seconds"}},got:{expression:"got",format:function(t){return'job <a href="/jobs/view?job_id='+t.args.payload.id+'" rel="contents" title="View job details">#'+t.args.payload.id+"</a>"}},process:{expression:"process",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fork:{expression:"fork",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},done:{expression:"done",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fail:{expression:"fail",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},start:{expression:"start",format:function(t){return"worker #"+t.worker}},stop:{expression:"shutdown",format:function(t){return"worker #"+t.worker}},pause:{expression:"pause",format:function(t){return"worker #"+t.worker}},resume:{expression:"resume",format:function(t){return"worker #"+t.worker}},prune:{expression:"prune",format:function(t){return"worker #"+t.worker}}};for(var c in l)l.hasOwnProperty(c)&&e(c);var d={100:{name:"debug",classStyle:"label-success"},200:{name:"info",classStyle:"label-info"},300:{name:"warning",classStyle:"label-warning"},400:{name:"error",classStyle:"label-important"},500:{name:"critical",classStyle:"label-inverse"},550:{name:"alert",classStyle:"label-inverse"}},u={},p=function(t,e){return{time:e.time,hourTime:moment(e.time).format("H:mm:ss"),action:t,levelName:d[e.data.level].name,levelClass:d[e.data.level].classStyle,detail:l[t].format(e.data),worker:e.data.worker,workerClass:cleanWorkerName(e.data.worker),color:f(e)}},f=function(t){return void 0===u[t.data.worker]&&(u[t.data.worker]=g[Object.keys(u).length]),u[t.data.worker]},g=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d #","17becf","#9edae5"];$("#clear-log-area").on("click",function(){$("#log-area").children().remove(),i()}),$("#log-filter-form").on("change","input",function(){var t=$(this).data("rel");$("#log-area").append('<li class="filter-event"><b>'+($(this).is(":checked")?"Start":"Stop")+"</b> listening to <em>"+t+"</em> events</li>");var e=$.cookie("ResqueBoard.mutedLevel",{path:"/logs"});if(e=e.split(","),$(this).is(":checked")){var a=e.indexOf(t);-1!==a&&e.splice(a,1)}else e[e.length]=t;$.cookie("ResqueBoard.mutedLevel",e.join(","),{expires:365,path:"/logs"})}),$("#log-sweeper-form").on("click","button[data-rel=verbosity]",function(){var t=$("#log-area").children("li[data-verbosity="+$(this).data("level")+"]");return s(t),t.remove(),!1}),$("#log-sweeper-form").on("click","button[data-rel=type]",function(){var t=$("#log-area").children("li[data-type="+$(this).data("type")+"]");return s(t),t.remove(),!1})}function listenToWorkersJob(t,e){function a(t){var e=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get");e.onopen=function(){e.send(JSON.stringify({expression:o[t].expression,start:formatISO(stop)}))},e.onmessage=function(e){r(t,JSON.parse(e.data))}}function r(t,e){switch(t){case"done":n.processDone(e);break;case"fail":n.processFail(e);break;case"stop":n.processStop(e);break;case"start":n.processStart(e)}}var n=function(){var t=function(t){return t.data.worker};return{processDone:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processGot:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processFail:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processStop:function(e){stopWorkerEvent(cleanWorkerName(t(e)))},processStart:function(t){startWorkerEvent(t.data.worker,e)}}}(),o={done:{expression:"done",format:function(t){return"job #"+t.job_id}},fail:{expression:"fail",format:function(t){return"job #"+t.job_id}},stop:{expression:"shutdown",format:function(t){return"worker #"+t.worker}},start:{expression:"start",format:function(t){return"worker #"+t.worker}}};for(var s in o)a(s);Job.initJobsChart(t)}function listenToWorkersActivities(){WorkerActivities.init()}function pieChart(t,e,a){var r=80,n=40,o=14,s=d3.scale.category20(),i=d3.layout.pie().value(function(t){return t.count}),l=$("#"+t),c=l.width(),d=250,u=d3.svg.arc().startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle}).innerRadius(n).outerRadius(r),p=function(t){return t>1e4?Math.round(t/1e3)+"K":t},f=d3.select(l[0]).append("svg:svg").attr("class","classyPieChart").attr("width",c).attr("height",d),g=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),h=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),m=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")");g.selectAll("path").data(i(a)).enter().append("svg:path").attr("d",u).attr("stroke","white").attr("stroke-width",.5).attr("fill",function(t,e){return s(e)}).each(function(t,e){a[e].startAngle=t.startAngle,a[e].endAngle=t.endAngle}),0===a.length&&(g.append("svg:circle").attr("fill","#EFEFEF").attr("r",r),m.append("svg:circle").attr("fill","white").attr("r",n)),m.append("svg:text").attr("class","pie-label").attr("dy",-15).attr("text-anchor","middle").text("TOTAL"),m.append("svg:text").attr("class","pie-total").attr("dy",7).attr("text-anchor","middle").text(p(e)),m.append("svg:text").attr("class","pie-units").attr("dy",21).attr("text-anchor","middle").text("jobs");var v=h.selectAll("line").data(a);v.enter().append("svg:line").attr("x1",0).attr("x2",0).attr("y1",-r-3).attr("y2",-r-8).attr("stroke","gray").attr("transform",function(t){return"rotate("+(t.startAngle+t.endAngle)/2*(180/Math.PI)+")"}),h.selectAll("text.pie-value").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).enter().append("svg:text").attr("class","pie-value").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.count+"%"});var b=h.selectAll("text.pie-units").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name});b.enter().append("svg:text").attr("class","pie-units").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name})}function initJobsOverview(){var t=500,e=$("#chart");(function(){var a=20,r=45,n=35,o=35,s=e.width(),i=e.height(),l={},c=[],d=d3.select("#chart").append("svg").attr("width",s).attr("height",i),u=d.append("text").attr("x",s/2).attr("y",i/2).attr("text-anchor","center").text("Loading …"),p=d.append("g").attr("class","x-axis").attr("transform","translate("+o+","+(i-n)+")"),f=d.append("g").attr("class","y-axis").attr("transform","translate("+(o-5)+","+a+")"),g=d.append("g").attr("class","y-axis right").attr("transform","translate("+(s-r+5)+","+a+")"),h=d3.svg.axis().orient("bottom").tickSize(-i+a-5+n,3,0).tickPadding(7),m=d3.svg.axis().tickSize(-s+o+r-5,3,0).orient("left").tickFormat(d3.format("s")).tickPadding(7),v=d3.svg.axis().orient("right").tickPadding(7),b={axis:{left:m,right:v,bottom:h},max:{left:{},right:{}}},w=d.append("g").attr("width",s-o+r).attr("height",i-a+n).attr("transform","translate("+o+","+a+")");d.append("text").attr("x",-90).attr("y",o+10).attr("transform","rotate(-90)").style("text-anchor","left").text("Jobs number").attr("class","graph-legend"),d.append("text").attr("x",-a).attr("y",s-o-10).attr("transform","rotate(-90)").style("text-anchor","end").text("Processing time in ms").attr("class","graph-legend");var k=function(t){var e=t.data("startDate"),a=t.data("endDate"),r=t.data("step");d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+r,function(t){if(u.remove(),null===t)return displayCubeNoFoundError();c=t.map(function(t){return{time:new Date(t.time),value:0}}),t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),b.max.left.processed={value:d3.max(t.map(function(t){return t.value})),status:1};var e=w.append("path").datum(t).attr("class","graph-line").attr("id","g-line-processed"),a=w.append("path").datum(t).attr("class","graph-area").attr("id","g-area-got");l.processed={line:e,area:a,data:t,yAxis:"left"},j(l.processed)})},y=function(e,a,r,n,o,s){return l.hasOwnProperty(o)?(b.max[s][o].status=1,l[o].line.datum(l[o].data),l[o].area.datum(l[o].data),l[o].line.transition().duration(t).style("opacity",1),j(l[o]),void 0):(d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression="+n+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+r,function(t){if(null===t)return displayCubeNoFoundError();t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),b.max[s][o]={value:d3.max(t.map(function(t){return t.value})),status:1};var e=w.append("path").datum(t).attr("class","graph-line").attr("id","g-line-"+o),a=w.append("path").attr("class","graph-area").attr("id","g-area-"+o);"right"!==s?a.datum(t):a.datum(c),l[o]={line:e,area:a,data:t,yAxis:s},j(l[o])}),void 0)},x=function(t){l.hasOwnProperty(t)&&(l[t].line.datum(c),l[t].area.datum(c),b.max[l[t].yAxis][t].status=0,j(l[t]))},j=function(e){function c(e){e.transition().duration(t).attr("d",w)}function d(a){l[a].yAxis===e.yAxis&&(l[a].area.transition().duration(t).attr("d",v),0===b.max[l[a].yAxis][a].status?(l[a].line.call(c),l[a].line.transition().delay(t).duration(100).style("opacity",0)):(l[a].line.style("opacity",1),l[a].line.call(c)))}var u=d3.scale.linear().domain([0,1.25*d3.max(d3.values(b.max[e.yAxis]).map(function(t){return 1===t.status?t.value:0}))]).range([i-a-n,0]),m=d3.time.scale().domain([e.data[0].time,e.data[e.data.length-1].time]).range([0,s-o-r]),v=d3.svg.area().x(function(t){return m(t.time)}).y0(function(){return i-n-a}).y1(function(t){return u(t.value)}),w=d3.svg.line().x(function(t){return m(t.time)}).y(function(t){return u(t.value)});for(var k in l)l.hasOwnProperty(k)&&d(k);h.scale(m),b.axis[e.yAxis].scale(u),"left"===e.yAxis?f.transition().duration(t).call(b.axis[e.yAxis]):g.transition().duration(t).call(b.axis[e.yAxis]),p.transition().duration(t).call(h)};k($("#date-range .active a")),$("#type-range").on("click","a",function(t){t.preventDefault();var e=$(this),a=$(this).parent().find("i");e.hasClass("active")?(x(e.data("type")),e.removeClass("active"),a.removeClass("icon-check"),a.addClass("icon-check-empty")):(e.addClass("active"),y(e.data("startDate"),e.data("endDate"),e.data("step"),e.data("expression"),e.data("type"),e.data("axis")),a.removeClass("icon-check-empty"),a.addClass("icon-check"))}),$(".date-range-form").on("click","button",function(t){t.preventDefault();var e=$(this).parents("form");console.log(e);var a={hour:"0",day:"1",month:"1",year:""},r="";"week"===$(this).data("range")?r=e.find("select option:selected").val():(e.find("select[name=range-hour]").length>0&&(a.hour=e.find("select[name=range-hour] option:selected").val()),e.find("select[name=range-day]").length>0&&(a.day=e.find("select[name=range-day] option:selected").val()),a.month=e.find("select[name=range-month] option:selected").val(),a.year=e.find("input[name=range-year]").val(),r=a.year+"-"+a.month+"-"+a.day+"T"+a.hour+":00:00"),window.location=e.attr("action")+$(this).data("range")+"/"+r})})()}function stopWorkerEvent(t){var e=$("#"+cleanWorkerName(t));1===e.length&&e.fadeOut(400,function(){if(e.remove(),$(".workers-count").length>0){var a=$(".workers-count"),r=a.html();a.html(parseInt(r,10)-1),fireEffect(a,"highlight")}var n=e.find(".queue-name");n.each(function(t){QueuesList.substract($(n[t]).text())}),Job.isInit()&&Job.removeJobChart(cleanWorkerName(t)),WorkerActivities.isInit()&&WorkerActivities.redraw(1===e.find("#worker-activities").length)})}function startWorkerEvent(t,e){$.ajax({url:"/render/worker/"+e+"/"+t,statusCode:{404:function(){alert("page not found")}}}).done(function(a){switch(e){case"list":$(".workers-list").append(a);break;case"table":$("#working-area tbody").append(a)}if($(".workers-count").length>0){var r=$(".workers-count").html();$(".workers-count").html(parseInt(r,10)+1),fireEffect($(".workers-count"),"highlight")}var n=$("#"+cleanWorkerName(t)).find(".queue-name");n.each(function(t){QueuesList.add($(n[t]).text())}),Job.isInit()&&Job.addJobChart(cleanWorkerName(t)),WorkerActivities.isInit()&&WorkerActivities.redraw()})}function cleanWorkerName(t){return"string"==typeof t?t.replace(RegExp("(\\.|:)","gm"),""):void 0}function fireEffect(t,e){0===t.queue("fx").length&&t.effect(e)}function parseInteger(t){return"string"==typeof t?+t.replace(/,/g,""):void 0}function number_format(t){return"integer"==typeof t?(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,","):void 0}function displayCubeNoFoundError(){var t=$('<div class="alert alert-error page-alert"><h4>Error</h4>Unable to connect to Cube server</div>').hide();$("#main").prepend(t),t.slideDown("slow").delay(2e3).slideUp("slow",function(){t.remove()})}function JobsCtrl(t,e,a){t.stats={processed:0,failed:0,pending:0,scheduled:0},e.onmessage(function(){t.stats.processed++}),a.onmessage(function(){t.stats.failed++})}function QueuesCtrl(t,e,a,r){a({method:"GET",url:"/api/queues"}).success(function(e){t.queues=e,t.length=Object.keys(e).length}).error(function(){}),t.stats={totaljobs:0};for(var n in t.queues)t.stats.totaljobs+=t.queues[n].stats.totaljobs;e.onmessage(function(e){var a=JSON.parse(e.data);t.queues[a.data.args.queue].stats.totaljobs++,t.stats.totaljobs++,t.queues[a.data.args.queue].stats.totaljobsperc=100*t.queues[a.data.args.queue].stats.totaljobs/t.stats.totaljobs}),r.onmessage(function(e){var a=JSON.parse(e.data),r=a.data.worker.split(":"),n=r[2].split(",");for(var o in n)t.queues.hasOwnProperty(n[o])?t.queues[n[o]].stats.workerscount++:t.queues[n[o]]={}})}function WorkersCtrl(t,e,a,r,n,o,s,i){t.workers={},t.length=0,e({method:"GET",url:"/api/workers"}).success(function(e){if(!$.isEmptyObject(e)){t.workers=e;var a=Object.keys(e);for(var r in a)t.updateJobRateCounter(a[r]),t.workers[a[r]].active=!0;t.length=a.length}}).error(function(){}),a.onmessage(function(e){var a=JSON.parse(e.data);t.workers.hasOwnProperty(a.data.worker)?(t.workers[a.data.worker].stats.processed++,t.updateJobRateCounter(a.data.worker)):console.log("jobs event before worker start")}),r.onmessage(function(e){var a=JSON.parse(e.data);t.workers.hasOwnProperty(a.data.worker)?t.workers[a.data.worker].stats.failed++:console.log("jobs event before worker start")}),t.updateJobRateCounter=function(e){var a=moment(t.workers[e].start),r=moment().diff(a,"minutes");t.workers[e].stats.jobrate=0===r?t.workers[e].stats.processed:t.workers[e].stats.processed/r},n.onmessage(function(e){var a=JSON.parse(e.data);console.log("Starting worker "+a.data.worker),console.log(a);var r=a.data.worker.split(":"),n=r[0]+":"+r[1],o={fullname:a.data.worker,id:n,host:r[0],process:r[1],queues:r[2].split(","),start:a.time,active:!0,stats:{processed:0,failed:0,jobrate:0}};t.workers[n]=o}),o.onmessage(function(e){var a=JSON.parse(e.data);console.log("Stopping worker "+a.data.worker),delete t.workers[a.data.worker]}),s.onmessage(function(e){var a=JSON.parse(e.data);t.workers[a.data.worker].active=!1,console.log("Pausing worker "+a.data.worker)}),i.onmessage(function(e){var a=JSON.parse(e.data);t.workers[a.data.worker].active=!0,console.log("Resuming worker "+a.data.worker)}),t.pause=function(e){var a=Object.keys(t.workers);t.workers[a[e]].active=!1,console.log("Pausing worker "+t.workers[a[e]].id)},t.resume=function(e){var a=Object.keys(t.workers);t.workers[a[e]].active=!0,console.log("Resuming worker "+t.workers[a[e]].id)},t.stop=function(){Object.keys(t.workers)}}$("[data-event~=tooltip]").tooltip(),$("[data-event~=collapse-all]").on("click",function(t){t.preventDefault(),$(".collapse.in").collapse("hide")}),$("[data-event~=expand-all]").on("click",function(t){t.preventDefault(),$(".collapse").not(".in").collapse("show")}),$("[data-event~=ajax-pagination]").on("change","select",function(){window.location=$(this).val()}),$(".infinite-scroll").infinitescroll({navSelector:"ul.pager",nextSelector:"ul.pager li.next a",itemSelector:".infinite-scroll li",loading:{finishedMsg:"No more pages to load.",img:"http://www.infinite-scroll.com/loading.gif"},bufferPx:5e3}),hljs.initHighlightingOnLoad();var stop=new Date(Date.now()),formatISO=function(t){var e=d3.time.format.iso;return e.parse(t)},duration=1500,step=[{second:10,code:"1e4"},{second:60,code:"6e4"},{second:300,code:"3e5"},{second:3600,code:"36e5"},{second:84600,code:"864e5"}],Job=function(){var t=0,e=0,a={},r="";return{initJobsChart:function(n){0!==$(".workers-list-item").length?($(".workers-list-item").each(function(){var e=$(this),r=e.find("[data-status=processed]"),n=e.find("[data-status=failed]"),o=parseInteger(r.html()),s=e.find("[data-type=chart]");a[e.attr("id")]={processedJobsCountDOM:r,processedJobsCount:o,failedJobsCountDOM:n,failedJobsCount:parseInteger(n.html()),chart:s,chartType:s.data("chart-type")},t+=o}),e=1,"pie"===n&&(jobPieChart.init(a),r=n)):e=2},addJobChart:function(t){var e=$("#"+t),n=e.find("[data-status=processed]"),o=e.find("[data-status=failed]"),s=parseInteger(n.html()),i=e.find("[data-type=chart]");a[t]={processedJobsCountDOM:n,processedJobsCount:s,failedJobsCountDOM:o,failedJobsCount:parseInteger(o.html()),chart:i,chartType:i.data("chart-type")},"pie"===r&&jobPieChart.add(a[t])},removeJobChart:function(t){delete a[t]},updateJobsChart:function(r,n){if(2!==e){a[r].processedJobsCount++,t++,400===n&&a[r].failedJobsCount++;var o=function(t,e){var r="processedJobsCount";e||(r="failedJobsCount"),a[t][r+"DOM"].html(number_format(a[t][r])),fireEffect(a[t][r+"DOM"],"highlight")};switch(400===n&&o(r,!1),o(r,!0),a[r].chartType){case"pie":jobPieChart.redraw(a[r],!0);break;case"horizontal-bar":for(var s=0,i=a.length;i>s;s++)a[s]!==!1&&a[s].chart.animate({width:Math.floor(100*(a[s].processedJobsCount/t))+"%"},500)}}},isInit:function(){return 0!==e}}}(),jobPieChart=function(){var t=function(t){var e=t.processedJobsCount-t.failedJobsCount,a=[{name:"success",count:0===e&&0===t.failedJobsCount?1:e,color:"#aec7e8"},{name:"failed",count:t.failedJobsCount,color:"#e7969c"}];return a},e=0;d3.scale.category20c();var a=d3.layout.pie().value(function(t){return t.count});return{init:function(r){for(var n in r)if(r.hasOwnProperty(n)){var o=t(r[n]),s=r[n].chart,i=(s.width()-2*e)/2,l=d3.svg.arc().innerRadius(i/2).outerRadius(i),c=d3.select(s[0]).append("svg:svg").attr("width",2*(i+e)).attr("height",2*(i+e)).append("svg:g").attr("transform","translate("+(i+e)+","+(i+e)+")");c.selectAll("path").data(a(o)).enter().append("svg:path").attr("d",l).attr("fill",function(t){return t.data.color}).attr("title",function(t){return t.data.count+" "+t.data.name+" jobs"}).each(function(t){this._current=t})}},add:function(r){var n=t(r),o=r.chart,s=(o.width()-2*e)/2,i=d3.svg.arc().innerRadius(s/2).outerRadius(s),l=d3.select(o[0]).append("svg:svg").attr("width",2*(s+e)).attr("height",2*(s+e)).append("svg:g").attr("transform","translate("+(s+e)+","+(s+e)+")");l.selectAll("path").data(a(n)).enter().append("svg:path").attr("d",i).attr("fill",function(t){return t.data.color}).attr("title",function(t){return t.data.count+" "+t.data.name+" jobs"}).each(function(t){this._current=t})},redraw:function(r){function n(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return l(e(t))}}var o=t(r),s=r.chart,i=(s.width()-2*e)/2,l=d3.svg.arc().innerRadius(i/2).outerRadius(i);d3.select(s[0]).select("svg").selectAll("path").data(a(o)).transition().duration(duration).attrTween("d",n)}}}(),WorkerActivities=function(){var t=!1,e=cubism.context().size(466),a=e.cube("http://"+CUBE_URL),r=e.horizon().metric(a.metric).height(53);return e.rule(),{isInit:function(){return t},init:function(){WorkerActivities.redraw(),t=!0},redraw:function(t){t?$("#working-area tbody tr:first-child td:last-child").append($('<div class="padd-fixer"><div id="worker-activities"></div></div>')):$("#worker-activities").empty();var a=[],n=[];if($(".worker-stats h4").each(function(){a.push($(this).text())}),0===a.length)return e.stop(),void 0;for(var o=0,s=a.length;s>o;o++)n.push('sum(done.eq(worker, "'+a[o]+'"))');d3.select("#worker-activities").append("div").attr("class","rule").call(e.rule()),d3.select("#worker-activities").selectAll(".horizon").data(n).enter().append("div").attr("class","horizon").call(r.extent([-180,180]).title(null)),d3.select("#worker-activities").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}}}();if($(".workers-list, #working-area").on("click",".stop-worker",function(t){t.preventDefault();var e=$(this).data("workerId"),a=$(this).data("workerName");$.ajax({url:"/api/workers/stop/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){t.status===!0?stopWorkerEvent(a):t.message?alert(t.message):alert("An unknown error has occured while stopping the worker")})}),$(".workers-list, #working-area").on("click",".pause-worker",function(t){t.preventDefault();var e=$(this).data("workerId"),a=$(this).data("workerName");$.ajax({url:"/api/workers/pause/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){t.status===!0?stopWorkerEvent(a):t.message?alert(t.message):alert("An unknown error has occured while pausing the worker")})}),$(".get-worker-info").on("click",function(t){t.preventDefault();var e=$(this).data("workerId");$.ajax({url:"/api/workers/getinfo/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){$("#worker-details .modal-body").html($("#workers-tpl").render(t)),$("#worker-details").modal("show")})}),$(".start-worker").on("click",function(t){t.preventDefault(),$.ajax({url:"/api/workers/start"}).done(function(t){$("#worker-form").html(t),$("#worker-form").modal("show"),$(".pop-over").popover({trigger:"hover"})})}),$("#scheduled-jobs-graph").length>0){var cal=new CalHeatMap;cal.init({id:"scheduled-jobs-graph",scale:[1,4,8,12],itemName:["job","jobs"],range:8,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/scheduled-jobs/stats/{{t:start}}/{{t:end}}",onClick:function(t){var e=d3.time.format("%H:%M, %A %B %e %Y");$("#scheduled-jobs-list").html('<h2>Jobs scheduled for <mark class="light">'+e(t)+"</mark></h2>"),$("#scheduled-jobs-list").append('<div class="alert alert-info" id="scheduled-jobs-loading">Loading datas ...</div>'),d3.json("/api/scheduled-jobs/"+ +t/1e3+"/"+(+t/1e3+60),function(t){$("#scheduled-jobs-loading").remove(),$("#scheduled-jobs-list").append('<ul class="unstyled job-details"></ul>');for(var e in t){for(var a in t[e])t[e][a].created=new Date(1e3*t[e][a].s_time),t[e][a].args=print_r(t[e][a].args);$("#scheduled-jobs-list ul").append($("#scheduled-jobs-list-tpl").render(t[e]))}var r=$("#scheduled-jobs-list ul li").length;0===r?$("#scheduled-jobs-list").append('<div class="alert">No jobs found for this period</div>'):$("#scheduled-jobs-list h2").prepend("<strong>"+r+"</strong> ")})}})}if($("#latest-jobs-graph").length>0){var cal=new CalHeatMap;cal.init({id:"latest-jobs-graph",scale:[1,4,8,12],itemName:["job","jobs"],range:6,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/jobs/stats/{{t:start}}/{{t:end}}",onClick:function(t){var e="latest-jobs-list",a=d3.time.format("%H:%M, %A %B %e %Y");$("#"+e).html('<h3>Jobs for <mark class="light">'+a(t)+"</mark></h3>"),$("#"+e).append('<div class="alert alert-info" id="latest-jobs-loading">Loading datas ...</div>'),d3.json("/api/jobs/"+ +t/1e3+"/"+(+t/1e3+60),function(t){$("#latest-jobs-loading").remove(),$("#"+e).append('<ul class="unstyled job-details"></ul>');for(var a in t){for(var r in t[a])t[a][r].created=new Date(1e3*t[a][r].s_time),t[a][r].args=print_r(t[a][r].args);$("#"+e+" ul").append($("#latest-jobs-list-tpl").render(t[a]))}var n=$("#"+e+" ul li").length;0===n?$("#"+e).append('<div class="alert">No jobs found for this period</div>'):$("#latest-jobs-list h3").prepend("<strong>"+n+"</strong> ")})}})}$(".navigator").on("change","select",function(){window.location=$("option",this).filter(":selected").val()});var print_r=function(t,e){var a=e||"",r="[object Array]"===Object.prototype.toString.call(t)?!0:!1,n=r?"Array\n"+a+"[\n":"Object\n"+a+"{\n";for(var o in t)if(t.hasOwnProperty(o)){var s=t[o],i="",l=Object.prototype.toString.call(s);switch(l){case"[object Array]":case"[object Object]":i=print_r(s,a+"	");break;case"[object String]":i='"'+s+'"';break;default:i=s}n+=a+"	"+o+" => "+i+",\n"}return n=n.substring(0,n.length-2)+"\n"+a,r?n+"]":n+"}"},ResqueBoard=angular.module("ResqueBoard",[]);ResqueBoard.filter("uptime",function(){return function(t){return moment().from(new Date(t),!0)}}),ResqueBoard.filter("urlencode",function(){return function(t){return encodeURIComponent(t)}});var SocketListener=function(t,e){var a=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get"),r=[];a.onopen=function(){var t=new Date;a.send(JSON.stringify({expression:e,start:t.toISOString()}))};var n=function(){a.onmessage=function(){var e=arguments;t.$apply(function(){for(var t in r)r[t].apply(a,e)})}},o=function(t){r.push(t)};return{onmessage:function(t){o(t),n()}}};ResqueBoard.factory("jobsProcessedCounter",function(t){var e=new SocketListener(t,"got");return e}),ResqueBoard.factory("jobsFailedCounter",function(t){var e=new SocketListener(t,"fail");return e}),ResqueBoard.factory("jobsSuccessCounter",function(t){var e=new SocketListener(t,"done");return e}),ResqueBoard.factory("workerStartListener",function(t){var e=new SocketListener(t,"start");return e}),ResqueBoard.factory("workerStopListener",function(t){var e=new SocketListener(t,"shutdown");return e}),ResqueBoard.factory("workerPauseListener",function(t){var e=new SocketListener(t,"pause");return e}),ResqueBoard.factory("workerResumeListener",function(t){var e=new SocketListener(t,"resume");return e});