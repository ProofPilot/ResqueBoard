function listenToJobsActivities(){var t=80;d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent("2012-07-07T16:00:00Z")+"&stop="+encodeURIComponent(formatISO(stop))+"&limit="+t+"&step="+step[0].code,function(e){function a(){d.domain([e[0].time,c(e[e.length-1].time)]),u.domain([0,d3.max(e.map(function(t){return t.value}))]);var t=f.selectAll("rect").data(e,function(t){return t.time});t.enter().insert("rect").call(h).attr("x",function(t){return d(c(t.time))}).attr("clip-path","url(#clip)").transition().duration(duration).attr("x",function(t){return d(t.time)+i+2}),t.transition().duration(duration).attr("clip-path","url(#clip)").call(g),t.exit().transition().duration(duration).attr("x",function(t){return d(t.time)+s}).remove(),b.transition().duration(duration).call(m),w.transition().duration(duration).call(v)}if(null===e)return displayCubeNoFoundError();var n={top:25,right:35,bottom:35,left:20},r=860-n.right-n.left,o=180-n.top-n.bottom,i=r/t-2,s=0,l=20,c=function(t){return t=new Date(t),new Date(t.setSeconds(t.getSeconds()+step[0].second))};e=e.map(function(t){return{time:new Date(t.time),value:t.value}}).slice(0,t);var d=d3.time.scale().domain([e[0].time,c(e[e.length-1].time)]).range([0,r]),u=d3.scale.linear().domain([0,d3.max(e.map(function(t){return t.value}))]).rangeRound([o,0]),p=d3.select("#lastest-jobs").append("svg").attr("class","chart").attr("width",r+n.left+n.right).attr("height",o+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");p.append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",r).attr("height",o),p.append("svg:text").attr("x",r).attr("y",-5).attr("text-anchor","end").text("jobs/10sec").attr("class","axis-legend"),p.append("svg:text").attr("x",r/2).attr("y",o+l+10).attr("text-anchor","middle").text("time").attr("class","axis-legend");var f=p.append("svg").attr("clip-path","url(#clip)").attr("class","bar-area"),h=function(t){t.attr("title",function(t){return t.value}).attr("data-target",".modal").on("click",function(t){displayJobsModal(t.time)}).call(g)},g=function(t){t.attr("x",function(t){return d(t.time)+s}).attr("y",function(t){return u(t.value)}).attr("width",i).attr("height",function(t){return o-u(t.value)})};f.selectAll("rect").data(e).enter().append("rect").call(h);var m=d3.svg.axis().scale(d).tickSubdivide(2).tickSize(6,3,0).orient("bottom"),v=d3.svg.axis().scale(u).tickSize(6,3,0).orient("right").ticks(4),b=p.append("g").attr("transform","translate(0,"+o+")").attr("class","x-axis").call(m),w=p.append("g").attr("class","y-axis").attr("transform","translate("+r+",0)").call(v),k=new WebSocket("ws://"+CUBE_URL+"/1.0/metric/get");k.onopen=function(){var t=c(e[e.length-1].time);k.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:c(t).toISOString(),limit:1,step:step[0].code}))},k.onmessage=function(t){var n=JSON.parse(t.data);n.hasOwnProperty("value")&&(n.time=new Date(n.time),e.shift(),e.push(n),a(),setTimeout(function(){var t=c(e[e.length-1].time);k.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:c(t).toISOString(),limit:1,step:step[0].code}))},1e3*step[0].second))}})}function displayJobsModal(t){var e=Date.parse(t)/1e3,a=$("#job-details").data("timestamp");a!==e?$.ajax({url:"/api/jobs/"+encodeURIComponent(e)+"/"+encodeURIComponent(e+step[0].second),success:function(t){$("#job-details .modal-body").html($("#jobs-tpl").render(t)),$("#job-details").data("timestamp",e),$("#job-details .modal-header .badge").html(t.length),$("#job-details").modal("show")}}):$("#job-details-modal").modal("show")}function loadLogs(){function t(t,e){$("input[data-rel="+d[e.data.level].name+"]").is(":checked")&&($("#log-area").append($("#log-template").render(p(t,e))),a.verbosity.hasOwnProperty(d[e.data.level].name)||n("verbosity",d[e.data.level].name,$("#log-sweeper-form span[data-rel="+d[e.data.level].name+"]")),a.type.hasOwnProperty([t])||n("type",t,$("#log-sweeper-form span[data-rel="+t+"]")),r("verbosity",d[e.data.level].name,1),r("type",t,1),r("general","g",1))}function e(e){var a=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get");a.onopen=function(){a.send(JSON.stringify({expression:l[e].expression,start:formatISO(stop)}))},a.onmessage=function(a){t(e,JSON.parse(a.data))}}var a={general:{g:$("[data-rel=log-counter]")},type:{},verbosity:{}},n=function(t,e,n){a[t][e]=n},r=function(t,e,n){var r=a[t][e];r.html(parseInteger(r.html())+n)},o=function(t,e,n){var r=a[t][e],o=parseInteger(r.html());o-n>=0&&(r.html(o-n),fireEffect(r,"highlight"))},i=function(t){t.each(function(){var t=$(this);o("type",t.data("type"),1),o("verbosity",t.data("verbosity"),1),o("general","g",1)})},s=function(){for(var t in a)if(a.hasOwnProperty(t))for(var e in a[t])a[t].hasOwnProperty(e)&&a[t][e].html(0)},l={sleep:{expression:"sleep",format:function(t){return"for "+t.second+" seconds"}},got:{expression:"got",format:function(t){return'job <a href="/jobs/view?job_id='+t.args.payload.id+'" rel="contents" title="View job details">#'+t.args.payload.id+"</a>"}},process:{expression:"process",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fork:{expression:"fork",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},done:{expression:"done",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fail:{expression:"fail",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},start:{expression:"start",format:function(t){return"worker #"+t.worker}},stop:{expression:"shutdown",format:function(t){return"worker #"+t.worker}},pause:{expression:"pause",format:function(t){return"worker #"+t.worker}},resume:{expression:"resume",format:function(t){return"worker #"+t.worker}},prune:{expression:"prune",format:function(t){return"worker #"+t.worker}}};for(var c in l)l.hasOwnProperty(c)&&e(c);var d={100:{name:"debug",classStyle:"label-success"},200:{name:"info",classStyle:"label-info"},300:{name:"warning",classStyle:"label-warning"},400:{name:"error",classStyle:"label-important"},500:{name:"critical",classStyle:"label-inverse"},550:{name:"alert",classStyle:"label-inverse"}},u={},p=function(t,e){return{time:e.time,hourTime:moment(e.time).format("H:mm:ss"),action:t,levelName:d[e.data.level].name,levelClass:d[e.data.level].classStyle,detail:l[t].format(e.data),worker:e.data.worker,workerClass:cleanWorkerName(e.data.worker),color:f(e)}},f=function(t){return void 0===u[t.data.worker]&&(u[t.data.worker]=h[Object.keys(u).length]),u[t.data.worker]},h=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d #","17becf","#9edae5"];$("#clear-log-area").on("click",function(){$("#log-area").children().remove(),s()}),$("#log-filter-form").on("change","input",function(){var t=$(this).data("rel");$("#log-area").append('<li class="filter-event"><b>'+($(this).is(":checked")?"Start":"Stop")+"</b> listening to <em>"+t+"</em> events</li>");var e=$.cookie("ResqueBoard.mutedLevel",{path:"/logs"});if(e=e.split(","),$(this).is(":checked")){var a=e.indexOf(t);-1!==a&&e.splice(a,1)}else e[e.length]=t;$.cookie("ResqueBoard.mutedLevel",e.join(","),{expires:365,path:"/logs"})}),$("#log-sweeper-form").on("click","button[data-rel=verbosity]",function(){var t=$("#log-area").children("li[data-verbosity="+$(this).data("level")+"]");return i(t),t.remove(),!1}),$("#log-sweeper-form").on("click","button[data-rel=type]",function(){var t=$("#log-area").children("li[data-type="+$(this).data("type")+"]");return i(t),t.remove(),!1})}function listenToWorkersJob(t,e){function a(t){var e=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get");e.onopen=function(){e.send(JSON.stringify({expression:o[t].expression,start:formatISO(stop)}))},e.onmessage=function(e){n(t,JSON.parse(e.data))}}function n(t,e){switch(t){case"done":r.processDone(e);break;case"fail":r.processFail(e);break;case"stop":r.processStop(e);break;case"start":r.processStart(e)}}var r=function(){var t=function(t){return t.data.worker};return{processDone:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processGot:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processFail:function(e){Job.updateJobsChart(cleanWorkerName(t(e)),e.data.level)},processStop:function(e){stopWorkerEvent(cleanWorkerName(t(e)))},processStart:function(t){startWorkerEvent(t.data.worker,e)}}}(),o={done:{expression:"done",format:function(t){return"job #"+t.job_id}},fail:{expression:"fail",format:function(t){return"job #"+t.job_id}},stop:{expression:"shutdown",format:function(t){return"worker #"+t.worker}},start:{expression:"start",format:function(t){return"worker #"+t.worker}}};for(var i in o)a(i);Job.initJobsChart(t)}function listenToWorkersActivities(){WorkerActivities.init()}function pieChart(t,e,a){var n=80,r=40,o=14,i=d3.scale.category20(),s=d3.layout.pie().value(function(t){return t.count}),l=$("#"+t),c=l.width(),d=250,u=d3.svg.arc().startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle}).innerRadius(r).outerRadius(n),p=function(t){return t>1e4?Math.round(t/1e3)+"K":t},f=d3.select(l[0]).append("svg:svg").attr("class","classyPieChart").attr("width",c).attr("height",d),h=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),g=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),m=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")");h.selectAll("path").data(s(a)).enter().append("svg:path").attr("d",u).attr("stroke","white").attr("stroke-width",.5).attr("fill",function(t,e){return i(e)}).each(function(t,e){a[e].startAngle=t.startAngle,a[e].endAngle=t.endAngle}),0===a.length&&(h.append("svg:circle").attr("fill","#EFEFEF").attr("r",n),m.append("svg:circle").attr("fill","white").attr("r",r)),m.append("svg:text").attr("class","pie-label").attr("dy",-15).attr("text-anchor","middle").text("TOTAL"),m.append("svg:text").attr("class","pie-total").attr("dy",7).attr("text-anchor","middle").text(p(e)),m.append("svg:text").attr("class","pie-units").attr("dy",21).attr("text-anchor","middle").text("jobs");var v=g.selectAll("line").data(a);v.enter().append("svg:line").attr("x1",0).attr("x2",0).attr("y1",-n-3).attr("y2",-n-8).attr("stroke","gray").attr("transform",function(t){return"rotate("+(t.startAngle+t.endAngle)/2*(180/Math.PI)+")"}),g.selectAll("text.pie-value").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).enter().append("svg:text").attr("class","pie-value").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(n+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(n+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.count+"%"});var b=g.selectAll("text.pie-units").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name});b.enter().append("svg:text").attr("class","pie-units").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(n+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(n+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name})}function initJobsOverview(){var t=500,e=$("#chart");(function(){var a=20,n=45,r=35,o=35,i=e.width(),s=e.height(),l={},c=[],d=d3.select("#chart").append("svg").attr("width",i).attr("height",s),u=d.append("text").attr("x",i/2).attr("y",s/2).attr("text-anchor","center").text("Loading …"),p=d.append("g").attr("class","x-axis").attr("transform","translate("+o+","+(s-r)+")"),f=d.append("g").attr("class","y-axis").attr("transform","translate("+(o-5)+","+a+")"),h=d.append("g").attr("class","y-axis right").attr("transform","translate("+(i-n+5)+","+a+")"),g=d3.svg.axis().orient("bottom").tickSize(-s+a-5+r,3,0).tickPadding(7),m=d3.svg.axis().tickSize(-i+o+n-5,3,0).orient("left").tickFormat(d3.format("s")).tickPadding(7),v=d3.svg.axis().orient("right").tickPadding(7),b={axis:{left:m,right:v,bottom:g},max:{left:{},right:{}}},w=d.append("g").attr("width",i-o+n).attr("height",s-a+r).attr("transform","translate("+o+","+a+")");d.append("text").attr("x",-90).attr("y",o+10).attr("transform","rotate(-90)").style("text-anchor","left").text("Jobs number").attr("class","graph-legend"),d.append("text").attr("x",-a).attr("y",i-o-10).attr("transform","rotate(-90)").style("text-anchor","end").text("Processing time in ms").attr("class","graph-legend");var k=function(t){var e=t.data("startDate"),a=t.data("endDate"),n=t.data("step");d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+n,function(t){if(u.remove(),null===t)return displayCubeNoFoundError();c=t.map(function(t){return{time:new Date(t.time),value:0}}),t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),b.max.left.processed={value:d3.max(t.map(function(t){return t.value})),status:1};var e=w.append("path").datum(t).attr("class","graph-line").attr("id","g-line-processed"),a=w.append("path").datum(t).attr("class","graph-area").attr("id","g-area-got");l.processed={line:e,area:a,data:t,yAxis:"left"},j(l.processed)})},x=function(e,a,n,r,o,i){return l.hasOwnProperty(o)?(b.max[i][o].status=1,l[o].line.datum(l[o].data),l[o].area.datum(l[o].data),l[o].line.transition().duration(t).style("opacity",1),j(l[o]),void 0):(d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression="+r+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+n,function(t){if(null===t)return displayCubeNoFoundError();t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),b.max[i][o]={value:d3.max(t.map(function(t){return t.value})),status:1};var e=w.append("path").datum(t).attr("class","graph-line").attr("id","g-line-"+o),a=w.append("path").attr("class","graph-area").attr("id","g-area-"+o);"right"!==i?a.datum(t):a.datum(c),l[o]={line:e,area:a,data:t,yAxis:i},j(l[o])}),void 0)},y=function(t){l.hasOwnProperty(t)&&(l[t].line.datum(c),l[t].area.datum(c),b.max[l[t].yAxis][t].status=0,j(l[t]))},j=function(e){function c(e){e.transition().duration(t).attr("d",w)}function d(a){l[a].yAxis===e.yAxis&&(l[a].area.transition().duration(t).attr("d",v),0===b.max[l[a].yAxis][a].status?(l[a].line.call(c),l[a].line.transition().delay(t).duration(100).style("opacity",0)):(l[a].line.style("opacity",1),l[a].line.call(c)))}var u=d3.scale.linear().domain([0,1.25*d3.max(d3.values(b.max[e.yAxis]).map(function(t){return 1===t.status?t.value:0}))]).range([s-a-r,0]),m=d3.time.scale().domain([e.data[0].time,e.data[e.data.length-1].time]).range([0,i-o-n]),v=d3.svg.area().x(function(t){return m(t.time)}).y0(function(){return s-r-a}).y1(function(t){return u(t.value)}),w=d3.svg.line().x(function(t){return m(t.time)}).y(function(t){return u(t.value)});for(var k in l)l.hasOwnProperty(k)&&d(k);g.scale(m),b.axis[e.yAxis].scale(u),"left"===e.yAxis?f.transition().duration(t).call(b.axis[e.yAxis]):h.transition().duration(t).call(b.axis[e.yAxis]),p.transition().duration(t).call(g)};k($("#date-range .active a")),$("#type-range").on("click","a",function(t){t.preventDefault();var e=$(this),a=$(this).parent().find("i");e.hasClass("active")?(y(e.data("type")),e.removeClass("active"),a.removeClass("icon-check"),a.addClass("icon-check-empty")):(e.addClass("active"),x(e.data("startDate"),e.data("endDate"),e.data("step"),e.data("expression"),e.data("type"),e.data("axis")),a.removeClass("icon-check-empty"),a.addClass("icon-check"))}),$(".date-range-form").on("click","button",function(t){t.preventDefault();var e=$(this).parents("form");console.log(e);var a={hour:"0",day:"1",month:"1",year:""},n="";"week"===$(this).data("range")?n=e.find("select option:selected").val():(e.find("select[name=range-hour]").length>0&&(a.hour=e.find("select[name=range-hour] option:selected").val()),e.find("select[name=range-day]").length>0&&(a.day=e.find("select[name=range-day] option:selected").val()),a.month=e.find("select[name=range-month] option:selected").val(),a.year=e.find("input[name=range-year]").val(),n=a.year+"-"+a.month+"-"+a.day+"T"+a.hour+":00:00"),window.location=e.attr("action")+$(this).data("range")+"/"+n})})()}function stopWorkerEvent(t){var e=$("#"+cleanWorkerName(t));1===e.length&&e.fadeOut(400,function(){if(e.remove(),$(".workers-count").length>0){var a=$(".workers-count"),n=a.html();a.html(parseInt(n,10)-1),fireEffect(a,"highlight")}var r=e.find(".queue-name");r.each(function(t){QueuesList.substract($(r[t]).text())}),Job.isInit()&&Job.removeJobChart(cleanWorkerName(t)),WorkerActivities.isInit()&&WorkerActivities.redraw(1===e.find("#worker-activities").length)})}function startWorkerEvent(t,e){$.ajax({url:"/render/worker/"+e+"/"+t,statusCode:{404:function(){alert("page not found")}}}).done(function(a){switch(e){case"list":$(".workers-list").append(a);break;case"table":$("#working-area tbody").append(a)}if($(".workers-count").length>0){var n=$(".workers-count").html();$(".workers-count").html(parseInt(n,10)+1),fireEffect($(".workers-count"),"highlight")}var r=$("#"+cleanWorkerName(t)).find(".queue-name");r.each(function(t){QueuesList.add($(r[t]).text())}),Job.isInit()&&Job.addJobChart(cleanWorkerName(t)),WorkerActivities.isInit()&&WorkerActivities.redraw()})}function cleanWorkerName(t){return"string"==typeof t?t.replace(RegExp("(\\.|:)","gm"),""):void 0}function fireEffect(t,e){0===t.queue("fx").length&&t.effect(e)}function parseInteger(t){return"string"==typeof t?+t.replace(/,/g,""):void 0}function number_format(t){return"integer"==typeof t?(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,","):void 0}function displayCubeNoFoundError(){var t=$('<div class="alert alert-error page-alert"><h4>Error</h4>Unable to connect to Cube server</div>').hide();$("#main").prepend(t),t.slideDown("slow").delay(2e3).slideUp("slow",function(){t.remove()})}function JobsCtrl(t,e){t.stats={processed:0,failed:0,pending:0,scheduled:0},e.onmessage(function(t){console.log(t)})}$("[data-event~=tooltip]").tooltip(),$("[data-event~=collapse-all]").on("click",function(t){t.preventDefault(),$(".collapse.in").collapse("hide")}),$("[data-event~=expand-all]").on("click",function(t){t.preventDefault(),$(".collapse").not(".in").collapse("show")}),$("[data-event~=ajax-pagination]").on("change","select",function(){window.location=$(this).val()}),$(".infinite-scroll").infinitescroll({navSelector:"ul.pager",nextSelector:"ul.pager li.next a",itemSelector:".infinite-scroll li",loading:{finishedMsg:"No more pages to load.",img:"http://www.infinite-scroll.com/loading.gif"},bufferPx:5e3}),hljs.initHighlightingOnLoad();var QueuesList=function(){function t(t){$(".queues-count").html(parseInt($(".queues-count").html(),10)-t),fireEffect($(".queues-count"),"highlight")}function e(t){$(".queues-count").html(parseInt($(".queues-count").html(),10)+t),fireEffect($(".queues-count"),"highlight")}var a=[],n=!1;return{init:function(){var t=$(".queues-list tr");t.each(function(e){if($(t[e]).find("td").length>0){var n=$(t[e]).find("td.queues-list-name").text(),r=$(t[e]).find("td.queues-list-count").text();a[n]={count:parseInt(r,10),dom:$(this)}}}),n=!0},add:function(t){return n===!1?!1:(a.hasOwnProperty(t)===!1&&($(".queues-list tbody").append($('<tr><td class="queues-list-name">'+t+'</td><td class="queues-list-count">0</td></tr>')),a[t]={count:0,dom:$(".queues-list tbody tr:last-child")},e(1)),a[t].count++,a[t].dom.find(".queues-list-count").html(a[t].count),fireEffect(a[t].dom,"highlight"),void 0)},substract:function(e){return n===!1?!1:(a.hasOwnProperty(e)&&(a[e].count--,0===a[e].count?(a[e].dom.remove(),delete a[e],t(1)):(a[e].dom.find(".queues-list-count").html(a[e].count),fireEffect(a[e].dom,"highlight"))),void 0)}}}(),stop=new Date(Date.now()),formatISO=function(t){var e=d3.time.format.iso;return e.parse(t)},duration=1500,step=[{second:10,code:"1e4"},{second:60,code:"6e4"},{second:300,code:"3e5"},{second:3600,code:"36e5"},{second:84600,code:"864e5"}],Job=function(){var t=0,e=0,a={},n="";return{initJobsChart:function(r){0!==$(".workers-list-item").length?($(".workers-list-item").each(function(){var e=$(this),n=e.find("[data-status=processed]"),r=e.find("[data-status=failed]"),o=parseInteger(n.html()),i=e.find("[data-type=chart]");a[e.attr("id")]={processedJobsCountDOM:n,processedJobsCount:o,failedJobsCountDOM:r,failedJobsCount:parseInteger(r.html()),chart:i,chartType:i.data("chart-type")},t+=o}),e=1,"pie"===r&&(jobPieChart.init(a),n=r)):e=2},addJobChart:function(t){var e=$("#"+t),r=e.find("[data-status=processed]"),o=e.find("[data-status=failed]"),i=parseInteger(r.html()),s=e.find("[data-type=chart]");a[t]={processedJobsCountDOM:r,processedJobsCount:i,failedJobsCountDOM:o,failedJobsCount:parseInteger(o.html()),chart:s,chartType:s.data("chart-type")},"pie"===n&&jobPieChart.add(a[t])},removeJobChart:function(t){delete a[t]},updateJobsChart:function(n,r){if(2!==e){a[n].processedJobsCount++,t++,400===r&&a[n].failedJobsCount++;var o=function(t,e){var n="processedJobsCount";e||(n="failedJobsCount"),a[t][n+"DOM"].html(number_format(a[t][n])),fireEffect(a[t][n+"DOM"],"highlight")};switch(400===r&&o(n,!1),o(n,!0),a[n].chartType){case"pie":jobPieChart.redraw(a[n],!0);break;case"horizontal-bar":for(var i=0,s=a.length;s>i;i++)a[i]!==!1&&a[i].chart.animate({width:Math.floor(100*(a[i].processedJobsCount/t))+"%"},500)}}},isInit:function(){return 0!==e}}}(),jobPieChart=function(){var t=function(t){var e=t.processedJobsCount-t.failedJobsCount,a=[{name:"success",count:0===e&&0===t.failedJobsCount?1:e,color:"#aec7e8"},{name:"failed",count:t.failedJobsCount,color:"#e7969c"}];return a},e=0;d3.scale.category20c();var a=d3.layout.pie().value(function(t){return t.count});return{init:function(n){for(var r in n)if(n.hasOwnProperty(r)){var o=t(n[r]),i=n[r].chart,s=(i.width()-2*e)/2,l=d3.svg.arc().innerRadius(s/2).outerRadius(s),c=d3.select(i[0]).append("svg:svg").attr("width",2*(s+e)).attr("height",2*(s+e)).append("svg:g").attr("transform","translate("+(s+e)+","+(s+e)+")");c.selectAll("path").data(a(o)).enter().append("svg:path").attr("d",l).attr("fill",function(t){return t.data.color}).attr("title",function(t){return t.data.count+" "+t.data.name+" jobs"}).each(function(t){this._current=t})}},add:function(n){var r=t(n),o=n.chart,i=(o.width()-2*e)/2,s=d3.svg.arc().innerRadius(i/2).outerRadius(i),l=d3.select(o[0]).append("svg:svg").attr("width",2*(i+e)).attr("height",2*(i+e)).append("svg:g").attr("transform","translate("+(i+e)+","+(i+e)+")");l.selectAll("path").data(a(r)).enter().append("svg:path").attr("d",s).attr("fill",function(t){return t.data.color}).attr("title",function(t){return t.data.count+" "+t.data.name+" jobs"}).each(function(t){this._current=t})},redraw:function(n){function r(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return l(e(t))}}var o=t(n),i=n.chart,s=(i.width()-2*e)/2,l=d3.svg.arc().innerRadius(s/2).outerRadius(s);d3.select(i[0]).select("svg").selectAll("path").data(a(o)).transition().duration(duration).attrTween("d",r)}}}(),WorkerActivities=function(){var t=!1,e=cubism.context().size(466),a=e.cube("http://"+CUBE_URL),n=e.horizon().metric(a.metric).height(53);return e.rule(),{isInit:function(){return t},init:function(){WorkerActivities.redraw(),t=!0},redraw:function(t){t?$("#working-area tbody tr:first-child td:last-child").append($('<div class="padd-fixer"><div id="worker-activities"></div></div>')):$("#worker-activities").empty();var a=[],r=[];if($(".worker-stats h4").each(function(){a.push($(this).text())}),0===a.length)return e.stop(),void 0;for(var o=0,i=a.length;i>o;o++)r.push('sum(done.eq(worker, "'+a[o]+'"))');d3.select("#worker-activities").append("div").attr("class","rule").call(e.rule()),d3.select("#worker-activities").selectAll(".horizon").data(r).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select("#worker-activities").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}}}();if($(".workers-list, #working-area").on("click",".stop-worker",function(t){t.preventDefault();var e=$(this).data("workerId"),a=$(this).data("workerName");$.ajax({url:"/api/workers/stop/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){t.status===!0?stopWorkerEvent(a):t.message?alert(t.message):alert("An unknown error has occured while stopping the worker")})}),$(".workers-list, #working-area").on("click",".pause-worker",function(t){t.preventDefault();var e=$(this).data("workerId"),a=$(this).data("workerName");$.ajax({url:"/api/workers/pause/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){t.status===!0?stopWorkerEvent(a):t.message?alert(t.message):alert("An unknown error has occured while pausing the worker")})}),$(".get-worker-info").on("click",function(t){t.preventDefault();var e=$(this).data("workerId");$.ajax({url:"/api/workers/getinfo/"+e,statusCode:{404:function(){alert("page not found")}}}).done(function(t){$("#worker-details .modal-body").html($("#workers-tpl").render(t)),$("#worker-details").modal("show")})}),$(".start-worker").on("click",function(t){t.preventDefault(),$.ajax({url:"/api/workers/start"}).done(function(t){$("#worker-form").html(t),$("#worker-form").modal("show"),$(".pop-over").popover({trigger:"hover"})})}),$("#scheduled-jobs-graph").length>0){var cal=new CalHeatMap;cal.init({id:"scheduled-jobs-graph",scale:[1,4,8,12],itemName:["job","jobs"],range:8,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/scheduled-jobs/stats/{{t:start}}/{{t:end}}",onClick:function(t){var e=d3.time.format("%H:%M, %A %B %e %Y");$("#scheduled-jobs-list").html('<h2>Jobs scheduled for <mark class="light">'+e(t)+"</mark></h2>"),$("#scheduled-jobs-list").append('<div class="alert alert-info" id="scheduled-jobs-loading">Loading datas ...</div>'),d3.json("/api/scheduled-jobs/"+ +t/1e3+"/"+(+t/1e3+60),function(t){$("#scheduled-jobs-loading").remove(),$("#scheduled-jobs-list").append('<ul class="unstyled job-details"></ul>');for(var e in t){for(var a in t[e])t[e][a].created=new Date(1e3*t[e][a].s_time),t[e][a].args=print_r(t[e][a].args);$("#scheduled-jobs-list ul").append($("#scheduled-jobs-list-tpl").render(t[e]))}var n=$("#scheduled-jobs-list ul li").length;0===n?$("#scheduled-jobs-list").append('<div class="alert">No jobs found for this period</div>'):$("#scheduled-jobs-list h2").prepend("<strong>"+n+"</strong> ")})}})}if($("#latest-jobs-graph").length>0){var cal=new CalHeatMap;cal.init({id:"latest-jobs-graph",scale:[1,4,8,12],itemName:["job","jobs"],range:6,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/jobs/stats/{{t:start}}/{{t:end}}",onClick:function(t){var e="latest-jobs-list",a=d3.time.format("%H:%M, %A %B %e %Y");$("#"+e).html('<h3>Jobs for <mark class="light">'+a(t)+"</mark></h3>"),$("#"+e).append('<div class="alert alert-info" id="latest-jobs-loading">Loading datas ...</div>'),d3.json("/api/jobs/"+ +t/1e3+"/"+(+t/1e3+60),function(t){$("#latest-jobs-loading").remove(),$("#"+e).append('<ul class="unstyled job-details"></ul>');for(var a in t){for(var n in t[a])t[a][n].created=new Date(1e3*t[a][n].s_time),t[a][n].args=print_r(t[a][n].args);$("#"+e+" ul").append($("#latest-jobs-list-tpl").render(t[a]))}var r=$("#"+e+" ul li").length;0===r?$("#"+e).append('<div class="alert">No jobs found for this period</div>'):$("#latest-jobs-list h3").prepend("<strong>"+r+"</strong> ")})}})}$(".navigator").on("change","select",function(){window.location=$("option",this).filter(":selected").val()});var print_r=function(t,e){var a=e||"",n="[object Array]"===Object.prototype.toString.call(t)?!0:!1,r=n?"Array\n"+a+"[\n":"Object\n"+a+"{\n";for(var o in t)if(t.hasOwnProperty(o)){var i=t[o],s="",l=Object.prototype.toString.call(i);switch(l){case"[object Array]":case"[object Object]":s=print_r(i,a+"	");break;case"[object String]":s='"'+i+'"';break;default:s=i}r+=a+"	"+o+" => "+s+",\n"}return r=r.substring(0,r.length-2)+"\n"+a,n?r+"]":r+"}"},ResqueBoard=angular.module("ResqueBoard",[]);ResqueBoard.factory("jobsProcessedCounter",function(t){var e=new WebSocket("ws://"+CUBE_URL+"/1.0/metric/get");return e.onopen=function(){e.send(JSON.stringify({expression:"sum(got)",start:0}))},{onmessage:function(a){e.onmessage=function(){var n=arguments;t.$apply(function(){a.apply(e,n)})}}}});