/**
 * ResqueBoard Javascript File
 *
 * Make all the numbers on the screen blink
 *
 * Licensed under The MIT License
 * Redistributions of files must retain the above copyright notice.
 *
 * @author		Wan Qi Chen <kami@kamisama.me>
 * @copyright     Copyright 2012, Wan Qi Chen <kami@kamisama.me>
 * @link			http://resqueboard.kamisama.me
 * @since		 1.0.0
 * @license	 MIT License (http://www.opensource.org/licenses/mit-license.ctp)
 */function listenToJobsActivities(){var e=25;d3.json("http://"+serverIp+":1081/1.0/metric/get"+"?expression=sum(got)"+"&start=2012-07-07T16:00:00Z"+"&stop="+formatISO(stop)+"&limit="+e+"&step="+step[0].code,function(t){function S(){l.domain([t[0].time,f(t[t.length-1].time)]),c.domain([0,d3.max(t.map(function(e){return e.value}))]);var e=p.selectAll("rect").data(t,function(e){return e.time}),n=p.selectAll("text").data(t,function(e){return e.time});e.enter().insert("rect").call(d).attr("x",function(e,t){return l(f(e.time))}).attr("clip-path","url(#clip)").transition().duration(duration).attr("x",function(e){return l(e.time)+o+2}),e.transition().duration(duration).attr("clip-path","url(#clip)").call(v),e.exit().transition().duration(duration).attr("x",function(e,t){return l(e.time)+u}).remove(),n.enter().insert("text").call(m).attr("x",function(e){return l(f(f(e.time)))-o/2}).transition().duration(duration).attr("x",function(e){return l(e.time)+o/2}),n.transition().duration(duration).call(g),n.exit().transition().duration(duration).attr("x",function(e){return l(e.time)+o/2}).remove(),w.transition().duration(duration).call(y),E.transition().duration(duration).call(b)}var n={top:25,right:35,bottom:35,left:20},r=620-n.right-n.left,i=180-n.top-n.bottom,s=i,o=r/e-2,u=0,a=20,f=function(e){return e=new Date(e),new Date(e.setSeconds(e.getSeconds()+step.second))};t=t.map(function(e){return{time:new Date(e.time),value:e.value}}).slice(0,e);var l=d3.time.scale().domain([t[0].time,f(t[t.length-1].time)]).range([0,r]),c=d3.scale.linear().domain([0,d3.max(t.map(function(e){return e.value}))]).rangeRound([i,0]),h=d3.select("#lastest-jobs").append("svg").attr("class","chart").attr("width",r+n.left+n.right).attr("height",i+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");h.append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",r).attr("height",i),h.append("svg:text").attr("x",r).attr("y",-5).attr("text-anchor","end").text("jobs/10sec").attr("class","axis-legend"),h.append("svg:text").attr("x",r/2).attr("y",i+a+10).attr("text-anchor","middle").text("time (min:sec)").attr("class","axis-legend");var p=h.append("svg").attr("clip-path","url(#clip)").attr("class","bar-area"),d=function(e){e.attr("title",function(e){return e.value}).attr("data-target","#job-details-modal").on("click",function(e){displayJobsModal(e.time)}).call(v)},v=function(e){e.attr("x",function(e){return l(e.time)+u}).attr("y",function(e){return c(e.value)}).attr("width",o).attr("height",function(e){return i-c(e.value)})};p.selectAll("rect").data(t).enter().append("rect").call(d);var m=function(e){e.attr("text-anchor","middle").attr("class",function(e){return i-c(e.value)<=a?"bar-label out":"bar-label"}).text(function(e){return e.value}).call(g)},g=function(e){e.attr("y",function(e){return i-c(e.value)>a?c(e.value):c(e.value)-a}).attr("dy","1.5em").attr("x",function(e){return l(e.time)+o/2})};p.selectAll("text").data(t).enter().append("text").attr("x",function(e){return l(e.time)+o/2}).call(m);var y=d3.svg.axis().scale(l).ticks(d3.time.seconds,30).tickFormat(d3.time.format("%M:%S")).tickSubdivide(2).tickSize(6,3,0).orient("bottom"),b=d3.svg.axis().scale(c).tickSize(6,3,0).orient("right").ticks(4),w=h.append("g").attr("transform","translate(0,"+i+")").attr("class","x-axis").call(y),E=h.append("g").attr("class","y-axis").attr("transform","translate("+r+",0)").call(b),x=new WebSocket("ws://"+serverIp+":1081/1.0/metric/get");x.onopen=function(){var e=f(t[t.length-1].time);x.send(JSON.stringify({expression:"sum(got)",start:e.toISOString(),stop:f(e).toISOString(),limit:1,step:step.code}))},x.onmessage=function(e){JsonData=JSON.parse(e.data),JsonData.hasOwnProperty("value")&&(JsonData.time=new Date(JsonData.time),t.shift(),t.push(JsonData),S(),setTimeout(function(){var e=f(t[t.length-1].time);x.send(JSON.stringify({expression:"sum(got)",start:e.toISOString(),stop:f(e).toISOString(),limit:1,step:step.code}))},step.second*1e3))}})}function displayJobsModal(e){startTimeStamp=Date.parse(e)/1e3;var t=$("#job-details").data("timestamp");t!=startTimeStamp?$.ajax({url:"/api/jobs/"+startTimeStamp+"/"+(startTimeStamp+step.second),success:function(e){$("#job-details .modal-body").html($("#jobs-tpl").render(e)),$("#job-details").data("timestamp",startTimeStamp),$("#job-details .modal-header .badge").html(e.length),$("#job-details").modal("show")}}):$("#job-details-modal").modal("show")}function loadLogs(){function p(e,i){$("input[data-rel="+a[i.data.level].name+"]").is(":checked")&&($("#log-area").append($("#log-template").render(l(e,i))),t.verbosity.hasOwnProperty(a[i.data.level].name)||n("verbosity",a[i.data.level].name,$("#log-sweeper-form span[data-rel="+a[i.data.level].name+"]")),t.type.hasOwnProperty([e])||n("type",e,$("#log-sweeper-form span[data-rel="+e+"]")),r("verbosity",a[i.data.level].name,1),r("type",e,1),r("general","g",1),$("#log-area").find("time").each(function(){$(this).html(moment($(this).attr("title")).fromNow()).tooltip()}))}function d(e){var t=new WebSocket("ws://"+serverIp+":1081/1.0/event/get");t.onopen=function(){t.send(JSON.stringify({expression:u[e].expression,start:formatISO(stop)}))},t.onmessage=function(t){p(e,JSON.parse(t.data))}}var t={general:{g:$("[data-rel=log-counter]")},type:{},verbosity:{}},n=function(e,n,r){t[e][n]=r},r=function(e,n,r){var i=t[e][n];i.html(parseInteger(i.html())+r),i.queue("fx")==0&&i.effect("highlight")},i=function(e,n,r){var i=t[e][n],s=parseInteger(i.html());s-r>=0&&(i.html(s-r),i.queue("fx")==0&&i.effect("highlight"))},s=function(e){e.each(function(){var e=$(this);i("type",e.data("type"),1),i("verbosity",e.data("verbosity"),1),i("general","g",1)})},o=function(){for(cat in t)for(type in t[cat])t[cat][type].html(0)},u={sleep:{expression:"sleep",format:function(e){return"for "+e.second+" seconds"}},got:{expression:"got",format:function(e){return"job #"+e.args.payload.id}},process:{expression:"process",format:function(e){return"job #"+e.job_id}},fork:{expression:"fork",format:function(e){return"job #"+e.job_id}},done:{expression:"done",format:function(e){return"job #"+e.job_id}},fail:{expression:"fail",format:function(e){return"job #"+e.job_id}}};for(e in u)d(e);var a={100:{name:"debug","class":"label-success"},200:{name:"info","class":"label-info"},300:{name:"warning","class":"label-warning"},400:{name:"error","class":"label-important"},500:{name:"critical","class":"label-inverse"},550:{name:"alert","class":"label-inverse"}},f={},l=function(e,t){return{time:t.time,relativeTime:moment(t.time).fromNow(),action:e,levelName:a[t.data.level].name,levelClass:a[t.data.level].class,detail:u[e].format(t.data),worker:t.data.worker,workerClass:t.data.worker.replace(new RegExp("(\\.|:)","gm"),""),color:c(t)}},c=function(e){return f[e.data.worker]==undefined&&(f[e.data.worker]=h[Object.keys(f).length]),f[e.data.worker]},h=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d #","17becf","#9edae5"];$("#clear-log-area").on("click",function(){$("#log-area").children().remove(),o()}),$("#log-filter-form").on("change","input",function(e){var t=$(this).data("rel");$("#log-area").append("<li class='filter-event'><b>"+($(this).is(":checked")?"Start":"Stop")+"</b> listening to <em>"+t+"</em> events</li>");var n=$.cookie("ResqueBoard.mutedLevel",{path:"/logs"});n=n.split(",");if($(this).is(":checked")){var r=n.indexOf(t);r!=-1&&n.splice(r,1)}else n[n.length]=t;$.cookie("ResqueBoard.mutedLevel",n.join(","),{expires:365,path:"/logs"})}),$("#log-sweeper-form").on("click","button[data-rel=verbosity]",function(e){var t=$("#log-area").children("li[data-verbosity="+$(this).data("level")+"]");return s(t),t.remove(),!1}),$("#log-sweeper-form").on("click","button[data-rel=type]",function(e){var t=$("#log-area").children("li[data-type="+$(this).data("type")+"]");return s(t),t.remove(),!1}),$("#log-area").on("mouseenter","li",function(){$("#log-area li[data-worker="+$(this).data("worker")+"]").addClass("hover-highlight")}),$("#log-area").on("mouseleave","li",function(){$("#log-area li[data-worker="+$(this).data("worker")+"]").removeClass("hover-highlight")})}function listenToWorkersJob(t){function i(e){var t=new WebSocket("ws://"+serverIp+":1081/1.0/event/get");t.onopen=function(){t.send(JSON.stringify({expression:r[e].expression,start:formatISO(stop)}))},t.onmessage=function(t){s(e,JSON.parse(t.data))}}function s(e,t){switch(e){case"done":n.processDone(t);break;case"fail":n.processFail(t)}}var n=function(){var e=function(e){return e.data.worker};return{processDone:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)},processGot:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)},processFail:function(t){Job.updateJobsChart(e(t).replace(new RegExp("(\\.|:)","gm"),""),t.data.level)}}}(),r={done:{expression:"done",format:function(e){return"job #"+e.job_id}},fail:{expression:"fail",format:function(e){return"job #"+e.job_id}}};for(e in r)i(e);Job.initJobsChart(t)}function listenToWorkersActivities(){var e=cubism.context().size(466),t=e.cube("http://"+serverIp+":1081"),n=e.horizon().metric(t.metric).height(53),r=e.rule(),i=[],s=[];$(".worker-stats h4").each(function(e){i.push($(this).html())});if(i.length==0)return;for(index in i)s.push("sum(done.eq(worker,'"+i[index]+"'))");d3.select("#worker-activities").append("div").attr("class","rule").call(e.rule()),d3.select("#worker-activities").selectAll(".horizon").data(s).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select("#worker-activities").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}function parseInteger(e){return+e.replace(",","")}function number_format(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function pieChart(e,t,n){var r=0,i=80,s=40,o=14,u=d3.scale.category20(),a=d3.layout.pie().value(function(e){return e.count}),f=$("#"+e),l=f.width(),c=250,h=d3.svg.arc().startAngle(function(e){return e.startAngle}).endAngle(function(e){return e.endAngle}).innerRadius(s).outerRadius(i),p=function(e){return e>1e4?Math.round(e/1e3)+"K":e},d=d3.select(f[0]).append("svg:svg").attr("class","classyPieChart").attr("width",l).attr("height",c),v=d.append("svg:g").attr("transform","translate("+l/2+","+c/2+")"),m=d.append("svg:g").attr("transform","translate("+l/2+","+c/2+")"),g=d.append("svg:g").attr("transform","translate("+l/2+","+c/2+")");v.selectAll("path").data(a(n)).enter().append("svg:path").attr("d",h).attr("stroke","white").attr("stroke-width",.5).attr("fill",function(e,t){return u(t)}).each(function(e,t){n[t].startAngle=e.startAngle,n[t].endAngle=e.endAngle});if(n.length==0)var y=v.append("svg:circle").attr("fill","#EFEFEF").attr("r",i),b=g.append("svg:circle").attr("fill","white").attr("r",s);var w=g.append("svg:text").attr("class","pie-label").attr("dy",-15).attr("text-anchor","middle").text("TOTAL"),E=g.append("svg:text").attr("class","pie-total").attr("dy",7).attr("text-anchor","middle").text(p(t)),S=g.append("svg:text").attr("class","pie-units").attr("dy",21).attr("text-anchor","middle").text("jobs"),x=m.selectAll("line").data(n);x.enter().append("svg:line").attr("x1",0).attr("x2",0).attr("y1",-i-3).attr("y2",-i-8).attr("stroke","gray").attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"});var T=m.selectAll("text.pie-value").data(n).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?5:-7}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).enter().append("svg:text").attr("class","pie-value").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(i+o)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(i+o)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?5:-7}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.count+"%"}),N=m.selectAll("text.pie-units").data(n).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:5}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.name});N.enter().append("svg:text").attr("class","pie-units").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(i+o)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(i+o)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:5}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.name})}function jobsLoad(){var e=cubism.context().size($("#jobs-load").width()),t=e.cube("http://"+serverIp+":1081"),n=e.horizon().metric(t.metric).height(100),r=e.rule(),i=[],s=[];s.push("sum(got)"),d3.select("#jobs-load").append("div").attr("class","rule").call(e.rule()),d3.select("#jobs-load").selectAll(".horizon").data(s).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select("#jobs-load").append("div").attr("class","axis").call(e.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))}function monthlyJobsLoad(){var e=function(e,t,n){d3.json("http://"+serverIp+":1081/1.0/metric/get"+"?expression=sum(got)"+"&start="+e+"&stop="+t+"&step="+step[4].code,function(e){e=e.map(function(e){return{time:new Date(e.time),value:e.value}});var t=$("#jobs-load-monthly").width(),r=$("#jobs-load-monthly").height(),i=20,s=5,o=35,u=45,a=d3.time.scale().domain([e[0].time,e[e.length-1].time]).range([0,t-u-s]),f=d3.scale.linear().domain([0,d3.max(e.map(function(e){return e.value}))]).range([r-i-o,0]);d3.select("#jobs-load-monthly").selectAll("svg").remove(),svg=d3.select("#jobs-load-monthly").append("svg").attr("width",t).attr("height",r);var l=d3.svg.line().x(function(e){return a(e.time)}).y(function(e){return f(e.value)}),c=d3.svg.area().x(function(e){return a(e.time)}).y0(r-o-i).y1(function(e){return f(e.value)}),h=d3.svg.axis().scale(a).tickFormat(d3.time.format("%d")).tickSubdivide(1).orient("bottom"),p=d3.svg.axis().scale(f).tickSize(-t+u+s).ticks(8).orient("left");svg.append("g").attr("class","x-axis").attr("transform","translate("+u+","+(r-o)+")").call(h),svg.append("g").attr("class","y-axis").attr("transform","translate("+u+","+i+")").call(p);var d=svg.append("g").attr("width",t-u+s).attr("height",r-i+o).attr("transform","translate("+u+","+i+")");d.append("path").attr("class","graph-line").attr("d",l(e)),d.append("path").attr("class","graph-area").attr("d",c(e)),svg.append("text").attr("x",t/2).attr("y",r-3).attr("text-anchor","middle").text(n).attr("class","graph-title"),svg.append("text").attr("x",u/2).attr("y",10).attr("text-anchor","left").text("Jobs/days").attr("class","graph-legend")})},t=function(){var t=$("#jobs-load-monthly-selector option:selected"),n=moment(t.val()+"-01","YYYY-MM-DD"),r=moment(n).add("M",1);e(n.format("YYYY-MM-DD"),r.format("YYYY-MM-DD"),t.text())};t(),$("#jobs-load-monthly-selector").on("change",function(e){t()})}var stop=new Date(Date.now());hljs.initHighlightingOnLoad();var formatISO=function(e){var t=d3.time.format.iso;return t.parse(e)},duration=1500,step=new Array({second:10,code:"1e4"},{second:60,code:"6e4"},{second:300,code:"3e5"},{second:3600,code:"36e5"},{second:84600,code:"864e5"}),Job=function(){var e=0,t=0,n={};return{initJobsChart:function(r){if($(".worker-stats").length!=0){var i=function(e){if($("#"+e).length==0)return!1;var t=$("#"+e),n=t.find("[data-status=processed]"),r=t.find("[data-status=failed]");return{processedJobsCountDOM:n,failedJobsCountDOM:r,processedJobsCount:parseInteger(n.html()),failedJobsCount:parseInteger(r.html()),chart:t.find("[data-type=chart]")}};$(".worker-stats").each(function(t){var r=$(this),i=r.find("[data-status=processed]"),s=r.find("[data-status=failed]"),o=parseInteger(i.html()),u=r.find("[data-type=chart]");n[r.attr("id")]={processedJobsCountDOM:i,processedJobsCount:o,failedJobsCountDOM:s,failedJobsCount:parseInteger(s.html()),chart:u,chartType:u.data("chart-type")},e+=o}),n["global-worker-stats"]=i("global-worker-stats"),n["active-worker-stats"]=i("active-worker-stats"),t=1,r=="pie"&&jobPieChart.init(n)}else t=2},updateJobsChart:function(r,i){if(t===2)return;n[r].processedJobsCount++,e++,i==400&&n[r].failedJobsCount++;var s=function(e,t){var r="processedJobsCount";t||(r="failedJobsCount"),n[e][r+"DOM"].html(number_format(n[e][r])),n[e][r+"DOM"].queue("fx")==0&&n[e][r+"DOM"].effect("highlight")};i==400&&s(r,!1),s(r,!0),n["active-worker-stats"]!=0&&(n["active-worker-stats"].processedJobsCount++,s("active-worker-stats",!0),i==400&&(n["active-worker-stats"].failedJobsCount++,s("active-worker-stats",!1))),n["global-worker-stats"]!=0&&(n["global-worker-stats"].processedJobsCount++,s("global-worker-stats",!0),i==400&&(n["global-worker-stats"].failedJobsCount++,s("global-worker-stats",!1)));switch(n[r].chartType){case"pie":jobPieChart.redraw(n[r],!0),jobPieChart.redraw(n["active-worker-stats"],!1),jobPieChart.redraw(n["global-worker-stats"],!1);break;case"horizontal-bar":for(_workerId in n)n[_workerId]!=0&&n[_workerId].chart.animate({width:Math.floor(n[_workerId].processedJobsCount/e*100)+"%"},500)}}}}(),jobPieChart=function(){var e=function(e){var t=e.processedJobsCount-e.failedJobsCount,n=[{name:"success",count:t==0&&e["failedJobsCount"]==0?1:t,color:"#aec7e8"},{name:"failed",count:e.failedJobsCount,color:"#e7969c"}];return n},t=0,n=d3.scale.category20c(),r=d3.layout.pie().value(function(e){return e.count});return{init:function(n){for(domain in n){var i=e(n[domain]),s=n[domain].chart,o=(s.width()-t*2)/2,u=d3.svg.arc().innerRadius(o/2).outerRadius(o),a=d3.select(s[0]).append("svg:svg").attr("width",(o+t)*2).attr("height",(o+t)*2).append("svg:g").attr("transform","translate("+(o+t)+","+(o+t)+")");a.selectAll("path").data(r(i)).enter().append("svg:path").attr("d",u).attr("fill",function(e){return e.data.color}).attr("title",function(e){return e.data.count+" "+e.data.name+" jobs"}).each(function(e){this._current=e})}},redraw:function(n){function a(e){var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return u(t(e))}}var i=e(n),s=n.chart,o=(s.width()-t*2)/2,u=d3.svg.arc().innerRadius(o/2).outerRadius(o);d3.select(s[0]).select("svg").selectAll("path").data(r(i)).transition().duration(duration).attrTween("d",a)}}}();$(document).ready(function(){$("[data-event~=tooltip]").tooltip(),$("[data-event~=collapse-all]").on("click",function(e){e.preventDefault(),$(".collapse.in").collapse("hide")}),$("[data-event~=expand-all]").on("click",function(e){e.preventDefault(),$(".collapse").not(".in").collapse("show")}),$("[data-event~=ajax-pagination]").on("change","select",function(e){window.location=$(this).val()})});