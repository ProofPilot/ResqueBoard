function listenToJobsActivities(t){var e=80;d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent("2012-07-07T16:00:00Z")+"&stop="+encodeURIComponent(formatISO(stop))+"&limit="+e+"&step="+step[0].code,function(a){function r(){u.domain([a[0].time,d(a[a.length-1].time)]),p.domain([0,d3.max(a.map(function(t){return t.value}))]);var t=g.selectAll("rect").data(a,function(t){return t.time});t.enter().insert("rect").call(m).attr("x",function(t){return u(d(t.time))}).attr("clip-path","url(#clip)").transition().duration(duration).attr("x",function(t){return u(t.time)+i+2}),t.transition().duration(duration).attr("clip-path","url(#clip)").call(h),t.exit().transition().duration(duration).attr("x",function(t){return u(t.time)+l}).remove(),b.transition().duration(duration).call(v),k.transition().duration(duration).call(w)}if(null===a)return displayCubeNoFoundError();var n={top:25,right:35,bottom:35,left:20},o=860-n.right-n.left,s=180-n.top-n.bottom,i=o/e-2,l=0,c=20,d=function(t){return t=new Date(t),new Date(t.setSeconds(t.getSeconds()+step[0].second))};a=a.map(function(t){return{time:new Date(t.time),value:t.value}}).slice(0,e);var u=d3.time.scale().domain([a[0].time,d(a[a.length-1].time)]).range([0,o]),p=d3.scale.linear().domain([0,d3.max(a.map(function(t){return t.value}))]).rangeRound([s,0]),f=d3.select("#lastest-jobs").append("svg").attr("class","chart").attr("width",o+n.left+n.right).attr("height",s+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");f.append("svg:clipPath").attr("id","clip").append("svg:rect").attr("width",o).attr("height",s),f.append("svg:text").attr("x",o).attr("y",-5).attr("text-anchor","end").text("jobs/10sec").attr("class","axis-legend"),f.append("svg:text").attr("x",o/2).attr("y",s+c+10).attr("text-anchor","middle").text("time").attr("class","axis-legend");var g=f.append("svg").attr("clip-path","url(#clip)").attr("class","bar-area"),m=function(e){e.attr("title",function(t){return t.value}).attr("data-target",".modal").on("click",function(e){t.viewJobs(e.time)}).call(h)},h=function(t){t.attr("x",function(t){return u(t.time)+l}).attr("y",function(t){return p(t.value)}).attr("width",i).attr("height",function(t){return s-p(t.value)})};g.selectAll("rect").data(a).enter().append("rect").call(m);var v=d3.svg.axis().scale(u).tickSubdivide(2).tickSize(6,3,0).orient("bottom"),w=d3.svg.axis().scale(p).tickSize(6,3,0).orient("right").ticks(4),b=f.append("g").attr("transform","translate(0,"+s+")").attr("class","x-axis").call(v),k=f.append("g").attr("class","y-axis").attr("transform","translate("+o+",0)").call(w),y=new WebSocket("ws://"+CUBE_URL+"/1.0/metric/get");y.onopen=function(){var t=d(a[a.length-1].time);y.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:d(t).toISOString(),limit:1,step:step[0].code}))},y.onmessage=function(t){var e=JSON.parse(t.data);e.hasOwnProperty("value")&&(e.time=new Date(e.time),a.shift(),a.push(e),r(),setTimeout(function(){var t=d(a[a.length-1].time);y.send(JSON.stringify({expression:"sum(got)",start:t.toISOString(),stop:d(t).toISOString(),limit:1,step:step[0].code}))},1e3*step[0].second))}})}function loadLogs(){function t(t,e){$("input[data-rel="+d[e.data.level].name+"]").is(":checked")&&($("#log-area").append($("#log-template").render(p(t,e))),a.verbosity.hasOwnProperty(d[e.data.level].name)||r("verbosity",d[e.data.level].name,$("#log-sweeper-form span[data-rel="+d[e.data.level].name+"]")),a.type.hasOwnProperty([t])||r("type",t,$("#log-sweeper-form span[data-rel="+t+"]")),n("verbosity",d[e.data.level].name,1),n("type",t,1),n("general","g",1))}function e(e){var a=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get");a.onopen=function(){a.send(JSON.stringify({expression:l[e].expression,start:formatISO(stop)}))},a.onmessage=function(a){t(e,JSON.parse(a.data))}}var a={general:{g:$("[data-rel=log-counter]")},type:{},verbosity:{}},r=function(t,e,r){a[t][e]=r},n=function(t,e,r){var n=a[t][e];n.html(parseInteger(n.html())+r)},o=function(t,e,r){var n=a[t][e],o=parseInteger(n.html());o-r>=0&&(n.html(o-r),fireEffect(n,"highlight"))},s=function(t){t.each(function(){var t=$(this);o("type",t.data("type"),1),o("verbosity",t.data("verbosity"),1),o("general","g",1)})},i=function(){for(var t in a)if(a.hasOwnProperty(t))for(var e in a[t])a[t].hasOwnProperty(e)&&a[t][e].html(0)},l={sleep:{expression:"sleep",format:function(t){return"for "+t.second+" seconds"}},got:{expression:"got",format:function(t){return'job <a href="/jobs/view?job_id='+t.args.payload.id+'" rel="contents" title="View job details">#'+t.args.payload.id+"</a>"}},process:{expression:"process",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fork:{expression:"fork",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},done:{expression:"done",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},fail:{expression:"fail",format:function(t){return'job <a href="/jobs/view?job_id='+t.job_id+'" rel="contents" title="View job details">#'+t.job_id+"</a>"}},start:{expression:"start",format:function(t){return"worker #"+t.worker}},stop:{expression:"shutdown",format:function(t){return"worker #"+t.worker}},pause:{expression:"pause",format:function(t){return"worker #"+t.worker}},resume:{expression:"resume",format:function(t){return"worker #"+t.worker}},prune:{expression:"prune",format:function(t){return"worker #"+t.worker}}};for(var c in l)l.hasOwnProperty(c)&&e(c);var d={100:{name:"debug",classStyle:"label-success"},200:{name:"info",classStyle:"label-info"},300:{name:"warning",classStyle:"label-warning"},400:{name:"error",classStyle:"label-important"},500:{name:"critical",classStyle:"label-inverse"},550:{name:"alert",classStyle:"label-inverse"}},u={},p=function(t,e){return{time:e.time,hourTime:moment(e.time).format("H:mm:ss"),action:t,levelName:d[e.data.level].name,levelClass:d[e.data.level].classStyle,detail:l[t].format(e.data),worker:e.data.worker,workerClass:cleanWorkerName(e.data.worker),color:f(e)}},f=function(t){return void 0===u[t.data.worker]&&(u[t.data.worker]=g[Object.keys(u).length]),u[t.data.worker]},g=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d #","17becf","#9edae5"];$("#clear-log-area").on("click",function(){$("#log-area").children().remove(),i()}),$("#log-filter-form").on("change","input",function(){var t=$(this).data("rel");$("#log-area").append('<li class="filter-event"><b>'+($(this).is(":checked")?"Start":"Stop")+"</b> listening to <em>"+t+"</em> events</li>");var e=$.cookie("ResqueBoard.mutedLevel",{path:"/logs"});if(e=e.split(","),$(this).is(":checked")){var a=e.indexOf(t);-1!==a&&e.splice(a,1)}else e[e.length]=t;$.cookie("ResqueBoard.mutedLevel",e.join(","),{expires:365,path:"/logs"})}),$("#log-sweeper-form").on("click","button[data-rel=verbosity]",function(){var t=$("#log-area").children("li[data-verbosity="+$(this).data("level")+"]");return s(t),t.remove(),!1}),$("#log-sweeper-form").on("click","button[data-rel=type]",function(){var t=$("#log-area").children("li[data-type="+$(this).data("type")+"]");return s(t),t.remove(),!1})}function pieChart(t,e,a){var r=80,n=40,o=14,s=d3.scale.category20(),i=d3.layout.pie().value(function(t){return t.count}),l=$("#"+t),c=l.width(),d=250,u=d3.svg.arc().startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle}).innerRadius(n).outerRadius(r),p=function(t){return t>1e4?Math.round(t/1e3)+"K":t},f=d3.select(l[0]).append("svg:svg").attr("class","classyPieChart").attr("width",c).attr("height",d),g=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),m=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")"),h=f.append("svg:g").attr("transform","translate("+c/2+","+d/2+")");g.selectAll("path").data(i(a)).enter().append("svg:path").attr("d",u).attr("stroke","white").attr("stroke-width",.5).attr("fill",function(t,e){return s(e)}).each(function(t,e){a[e].startAngle=t.startAngle,a[e].endAngle=t.endAngle}),0===a.length&&(g.append("svg:circle").attr("fill","#EFEFEF").attr("r",r),h.append("svg:circle").attr("fill","white").attr("r",n)),h.append("svg:text").attr("class","pie-label").attr("dy",-15).attr("text-anchor","middle").text("TOTAL"),h.append("svg:text").attr("class","pie-total").attr("dy",7).attr("text-anchor","middle").text(p(e)),h.append("svg:text").attr("class","pie-units").attr("dy",21).attr("text-anchor","middle").text("jobs");var v=m.selectAll("line").data(a);v.enter().append("svg:line").attr("x1",0).attr("x2",0).attr("y1",-r-3).attr("y2",-r-8).attr("stroke","gray").attr("transform",function(t){return"rotate("+(t.startAngle+t.endAngle)/2*(180/Math.PI)+")"}),m.selectAll("text.pie-value").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).enter().append("svg:text").attr("class","pie-value").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?5:-7}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.count+"%"});var w=m.selectAll("text.pie-units").data(a).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name});w.enter().append("svg:text").attr("class","pie-units").attr("transform",function(t){return"translate("+Math.cos((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+","+Math.sin((t.startAngle+t.endAngle-Math.PI)/2)*(r+o)+")"}).attr("dy",function(t){return(t.startAngle+t.endAngle)/2>Math.PI/2&&(t.startAngle+t.endAngle)/2<1.5*Math.PI?17:5}).attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2<Math.PI?"beginning":"end"}).text(function(t){return t.name})}function initJobsOverview(){var t=500,e=$("#chart");(function(){var a=20,r=45,n=35,o=35,s=e.width(),i=e.height(),l={},c=[],d=d3.select("#chart").append("svg").attr("width",s).attr("height",i),u=d.append("text").attr("x",s/2).attr("y",i/2).attr("text-anchor","center").text("Loading …"),p=d.append("g").attr("class","x-axis").attr("transform","translate("+o+","+(i-n)+")"),f=d.append("g").attr("class","y-axis").attr("transform","translate("+(o-5)+","+a+")"),g=d.append("g").attr("class","y-axis right").attr("transform","translate("+(s-r+5)+","+a+")"),m=d3.svg.axis().orient("bottom").tickSize(-i+a-5+n,3,0).tickPadding(7),h=d3.svg.axis().tickSize(-s+o+r-5,3,0).orient("left").tickFormat(d3.format("s")).tickPadding(7),v=d3.svg.axis().orient("right").tickPadding(7),w={axis:{left:h,right:v,bottom:m},max:{left:{},right:{}}},b=d.append("g").attr("width",s-o+r).attr("height",i-a+n).attr("transform","translate("+o+","+a+")");d.append("text").attr("x",-90).attr("y",o+10).attr("transform","rotate(-90)").style("text-anchor","left").text("Jobs number").attr("class","graph-legend"),d.append("text").attr("x",-a).attr("y",s-o-10).attr("transform","rotate(-90)").style("text-anchor","end").text("Processing time in ms").attr("class","graph-legend");var k=function(t){var e=t.data("startDate"),a=t.data("endDate"),r=t.data("step");d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression=sum(got)"+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+r,function(t){if(u.remove(),null===t)return displayCubeNoFoundError();c=t.map(function(t){return{time:new Date(t.time),value:0}}),t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),w.max.left.processed={value:d3.max(t.map(function(t){return t.value})),status:1};var e=b.append("path").datum(t).attr("class","graph-line").attr("id","g-line-processed"),a=b.append("path").datum(t).attr("class","graph-area").attr("id","g-area-got");l.processed={line:e,area:a,data:t,yAxis:"left"},j(l.processed)})},y=function(e,a,r,n,o,s){return l.hasOwnProperty(o)?(w.max[s][o].status=1,l[o].line.datum(l[o].data),l[o].area.datum(l[o].data),l[o].line.transition().duration(t).style("opacity",1),j(l[o]),void 0):(d3.json("http://"+CUBE_URL+"/1.0/metric/get"+"?expression="+n+"&start="+encodeURIComponent(e)+"&stop="+encodeURIComponent(a)+"&step="+r,function(t){if(null===t)return displayCubeNoFoundError();t=t.map(function(t){return{time:new Date(t.time),value:t.value}}),w.max[s][o]={value:d3.max(t.map(function(t){return t.value})),status:1};var e=b.append("path").datum(t).attr("class","graph-line").attr("id","g-line-"+o),a=b.append("path").attr("class","graph-area").attr("id","g-area-"+o);"right"!==s?a.datum(t):a.datum(c),l[o]={line:e,area:a,data:t,yAxis:s},j(l[o])}),void 0)},x=function(t){l.hasOwnProperty(t)&&(l[t].line.datum(c),l[t].area.datum(c),w.max[l[t].yAxis][t].status=0,j(l[t]))},j=function(e){function c(e){e.transition().duration(t).attr("d",b)}function d(a){l[a].yAxis===e.yAxis&&(l[a].area.transition().duration(t).attr("d",v),0===w.max[l[a].yAxis][a].status?(l[a].line.call(c),l[a].line.transition().delay(t).duration(100).style("opacity",0)):(l[a].line.style("opacity",1),l[a].line.call(c)))}var u=d3.scale.linear().domain([0,1.25*d3.max(d3.values(w.max[e.yAxis]).map(function(t){return 1===t.status?t.value:0}))]).range([i-a-n,0]),h=d3.time.scale().domain([e.data[0].time,e.data[e.data.length-1].time]).range([0,s-o-r]),v=d3.svg.area().x(function(t){return h(t.time)}).y0(function(){return i-n-a}).y1(function(t){return u(t.value)}),b=d3.svg.line().x(function(t){return h(t.time)}).y(function(t){return u(t.value)});for(var k in l)l.hasOwnProperty(k)&&d(k);m.scale(h),w.axis[e.yAxis].scale(u),"left"===e.yAxis?f.transition().duration(t).call(w.axis[e.yAxis]):g.transition().duration(t).call(w.axis[e.yAxis]),p.transition().duration(t).call(m)};k($("#date-range .active a")),$("#type-range").on("click","a",function(t){t.preventDefault();var e=$(this),a=$(this).parent().find("i");e.hasClass("active")?(x(e.data("type")),e.removeClass("active"),a.removeClass("icon-check"),a.addClass("icon-check-empty")):(e.addClass("active"),y(e.data("startDate"),e.data("endDate"),e.data("step"),e.data("expression"),e.data("type"),e.data("axis")),a.removeClass("icon-check-empty"),a.addClass("icon-check"))}),$(".date-range-form").on("click","button",function(t){t.preventDefault();var e=$(this).parents("form");console.log(e);var a={hour:"0",day:"1",month:"1",year:""},r="";"week"===$(this).data("range")?r=e.find("select option:selected").val():(e.find("select[name=range-hour]").length>0&&(a.hour=e.find("select[name=range-hour] option:selected").val()),e.find("select[name=range-day]").length>0&&(a.day=e.find("select[name=range-day] option:selected").val()),a.month=e.find("select[name=range-month] option:selected").val(),a.year=e.find("input[name=range-year]").val(),r=a.year+"-"+a.month+"-"+a.day+"T"+a.hour+":00:00"),window.location=e.attr("action")+$(this).data("range")+"/"+r})})()}function cleanWorkerName(t){return"string"==typeof t?t.replace(RegExp("(\\.|:)","gm"),""):void 0}function fireEffect(t,e){0===t.queue("fx").length&&t.effect(e)}function parseInteger(t){return"string"==typeof t?+t.replace(/,/g,""):void 0}function number_format(t){return"integer"==typeof t?(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,","):void 0}function displayCubeNoFoundError(){var t=$('<div class="alert alert-error page-alert"><h4>Error</h4>Unable to connect to Cube server</div>').hide();$("#main").prepend(t),t.slideDown("slow").delay(2e3).slideUp("slow",function(){t.remove()})}function JobsCtrl(t,e,a){t.stats={processed:0,failed:0,pending:0,scheduled:0},e.onmessage(function(){t.stats.processed++}),a.onmessage(function(){t.stats.failed++})}function QueuesCtrl(t,e,a,r){function n(){for(var e in t.queues)t.queues[e].stats.totaljobsperc=100*t.queues[e].stats.totaljobs/t.stats.totaljobs}t.stats={totaljobs:0},t.predicate="stats.totaljobs",t.reverse=!0;var o={};a({method:"GET",url:"/api/queues"}).success(function(e){t.queues=e,t.length=Object.keys(e).length;for(var a in t.queues)t.stats.totaljobs+=t.queues[a].stats.totaljobs,o[t.queues[a].name]=parseInt(a,10);n()}).error(function(){}),e.onmessage(function(e){var a=JSON.parse(e.data);t.queues[o[a.data.args.queue]].stats.totaljobs++,t.stats.totaljobs++}),r.onmessage(function(e){var a=JSON.parse(e.data),r=a.data.worker.split(":"),n=r[2].split(",");for(var o in n)t.queues.hasOwnProperty(n[o])?t.queues[n[o]].stats.workerscount++:t.queues[n[o]]={}})}function WorkersCtrl(t,e,a,r,n,o,s,i){t.workers={},t.length=0;var l={};t.jobsCount=0,e({method:"GET",url:"/api/workers"}).success(function(e){if(!$.isEmptyObject(e)){t.workers=e;var a=Object.keys(e);for(var r in a)t.jobsCount+=t.workers[a[r]].stats.processed,t.updateStats(a[r]),t.workers[a[r]].active=!0;t.length=a.length}}).error(function(){}),a.onmessage(function(e){var a=JSON.parse(e.data);t.workers.hasOwnProperty(a.data.worker)?(t.workers[a.data.worker].stats.processed++,t.updateStats(a.data.worker)):l.hasOwnProperty(a.data.worker)?l[a.data.worker].stats.processed++:l[a.data.worker]={stats:{processed:1,failed:0}},t.jobsCount++}),r.onmessage(function(e){var a=JSON.parse(e.data);t.workers.hasOwnProperty(a.data.worker)?t.workers[a.data.worker].stats.failed++:l.hasOwnProperty(a.data.worker)?l[a.data.worker].stats.failed++:l[a.data.worker]={stats:{processed:0,failed:1}}}),t.updateStats=function(e){var a=moment(t.workers[e].start),r=moment().diff(a,"minutes");t.workers[e].stats.jobrate=0===r?t.workers[e].stats.processed:t.workers[e].stats.processed/r,0!==t.jobsCount&&(t.workers[e].stats.jobperc=100*t.workers[e].stats.processed/t.jobsCount)},n.onmessage(function(e){var a=JSON.parse(e.data);console.log("Starting worker "+a.data.worker),console.log(a);var r=a.data.worker.split(":"),n=r[0]+":"+r[1],o={fullname:a.data.worker,id:n,host:r[0],process:r[1],queues:r[2].split(","),start:a.time,active:!0,stats:{processed:0,failed:0,jobrate:0,jobperc:0}};t.workers[n]=o,t.length++,l.hasOwnProperty(n)&&(t.workers[n].stats.processed+=l[n].stats.processed,t.workers[n].stats.failed+=l[n].stats.failed,delete l[n])}),o.onmessage(function(e){var a=JSON.parse(e.data);console.log("Stopping worker "+a.data.worker),delete t.workers[a.data.worker]}),s.onmessage(function(e){var a=JSON.parse(e.data);t.workers[a.data.worker].active=!1,console.log("Pausing worker "+a.data.worker)}),i.onmessage(function(e){var a=JSON.parse(e.data);t.workers[a.data.worker].active=!0,console.log("Resuming worker "+a.data.worker)}),t.pause=function(e,a){a.preventDefault(),t.workers[e].active=!1,console.log("Pausing worker "+t.workers[e].id)},t.resume=function(e,a){a.preventDefault(),t.workers[e].active=!0,console.log("Resuming worker "+t.workers[e].id)},t.stop=function(e,a){a.preventDefault(),delete t.workers[e],t.length--}}function LatestJobsGraphCtrl(t,e){t.jobs=[],listenToJobsActivities(t,e),t.viewJobs=function(a){var r=Date.parse(a)/1e3;e({method:"GET",url:"/api/jobs/"+encodeURIComponent(r)+"/"+encodeURIComponent(r+step[0].second)}).success(function(e){t.jobs=e,$("#job-details").modal("show")}).error(function(){})}}function ScheduledJobsCtrl(t,e){t.jobs=[],t.loading=!1,t.date=!1;var a=new CalHeatMap;a.init({id:"scheduled-jobs-graph",scale:[1,4,8,12],itemName:["job","jobs"],range:8,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/scheduled-jobs/stats/{{t:start}}/{{t:end}}",onClick:function(a){t.loading=!0;var r=d3.time.format("%H:%M, %A %B %e %Y");t.date=r(a),e({method:"GET",url:"/api/scheduled-jobs/"+ +a/1e3+"/"+(+a/1e3+60)}).success(function(e){t.jobs=[];for(var a in e){for(var r in e[a])e[a][r].created=new Date(1e3*e[a][r].s_time),e[a][r].args=print_r(e[a][r].args);t.jobs=e}t.loading=!1}).error(function(){})}}),t.clear=function(){t.date=!1,t.jobs=[]}}$("[data-event~=tooltip]").tooltip(),$("[data-event~=collapse-all]").on("click",function(t){t.preventDefault(),$(".collapse.in").collapse("hide")}),$("[data-event~=expand-all]").on("click",function(t){t.preventDefault(),$(".collapse").not(".in").collapse("show")}),$("[data-event~=ajax-pagination]").on("change","select",function(){window.location=$(this).val()}),$(".infinite-scroll").infinitescroll({navSelector:"ul.pager",nextSelector:"ul.pager li.next a",itemSelector:".infinite-scroll li",loading:{finishedMsg:"No more pages to load.",img:"http://www.infinite-scroll.com/loading.gif"},bufferPx:5e3}),$(".navigator").on("change","select",function(){window.location=$("option",this).filter(":selected").val()}),hljs.initHighlightingOnLoad();var stop=new Date(Date.now()),formatISO=function(t){var e=d3.time.format.iso;return e.parse(t)},duration=1500,step=[{second:10,code:"1e4"},{second:60,code:"6e4"},{second:300,code:"3e5"},{second:3600,code:"36e5"},{second:84600,code:"864e5"}],print_r=function(t,e){var a=e||"",r="[object Array]"===Object.prototype.toString.call(t)?!0:!1,n=r?"Array\n"+a+"[\n":"Object\n"+a+"{\n";for(var o in t)if(t.hasOwnProperty(o)){var s=t[o],i="",l=Object.prototype.toString.call(s);switch(l){case"[object Array]":case"[object Object]":i=print_r(s,a+"	");break;case"[object String]":i='"'+s+'"';break;default:i=s}n+=a+"	"+o+" => "+i+",\n"}return n=n.substring(0,n.length-2)+"\n"+a,r?n+"]":n+"}"},ResqueBoard=angular.module("ResqueBoard",[]);ResqueBoard.filter("uptime",function(){return function(t){return moment().from(new Date(t),!0)}}),ResqueBoard.filter("urlencode",function(){return function(t){return encodeURIComponent(t)}}),ResqueBoard.directive("iconJob",function(){var t={1:{icon:"job_waiting.png",name:"Pending"},2:{icon:"job_running.png",name:"Running"},3:{icon:"job_failed.png",name:"Failed"},4:{icon:"job_complete.png",name:"Completed"},63:{icon:"job_scheduled.png",name:"Scheduled"}};return{restrict:"E",template:"<img height=24 width=24 />",replace:!0,scope:{status:"="},link:function(e,a){a.attr("src","/img/"+t[e.status].icon),a.attr("title",t[e.status].name+" job")}}}),ResqueBoard.directive("graphHorizonChart",function(){return{restrict:"E",template:"<div></div>",replace:!0,scope:{workers:"=",length:"="},link:function(t,e){var a=cubism.context().size(466),r=a.cube("http://"+CUBE_URL),n=a.horizon().metric(r.metric).height(e.parent().parent().height()),o=(a.rule(),[]),s=function(){o=[],e.empty();for(var r in t.workers)o.push('sum(done.eq(worker, "'+t.workers[r].id+'"))');d3.select(e[0]).selectAll(".horizon").data(o).enter().append("div").attr("class","horizon").call(n.extent([-180,180]).title(null)),d3.select(e[0]).append("div").attr("class","rule").call(a.rule()),d3.select(e[0]).append("div").attr("class","axis").call(a.axis().orient("bottom").ticks(d3.time.minutes,10).tickSize(6,3,0).tickFormat(d3.time.format("%H:%M")))};s(),t.$watch("length",function(t,e){t!==e&&s()})}}}),ResqueBoard.directive("graphPie",function(){return{restrict:"E",template:"<div></div>",replace:!0,scope:{processedjobs:"=",failedjobs:"="},link:function(t,e){var a=[{name:"success",count:Math.max(1,t.processedjobs),color:"#aec7e8"},{name:"failed",count:t.failedjobs,color:"#e7969c"}],r=0;d3.scale.category20c();var n=(e.parent().width()-2*r)/2,o=d3.svg.arc().innerRadius(n/2).outerRadius(n),s=d3.layout.pie().value(function(t){return t.count}),i=d3.select(e[0]).append("svg:svg").attr("width",2*(n+r)).attr("height",2*(n+r)).append("svg:g").attr("transform","translate("+(n+r)+","+(n+r)+")");i.selectAll("path").data(s(a)).enter().append("svg:path").attr("d",o).attr("fill",function(t){return t.data.color}).attr("title",function(t){return t.data.count+" "+t.data.name+" jobs"}).each(function(t){this._current=t});var l=function(t){function e(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return o(e(t))}}i.selectAll("path").data(s(t)).transition().duration(duration).attrTween("d",e)};t.$watch("processedjobs",function(t,e){t!==e&&(a[0].count=t,l(a))}),t.$watch("failedjobs",function(t,e){t!==e&&(a[1].count=t,l(a))})}}});var SocketListener=function(t,e){var a=new WebSocket("ws://"+CUBE_URL+"/1.0/event/get"),r=[];a.onopen=function(){var t=new Date;a.send(JSON.stringify({expression:e,start:t.toISOString()}))};var n=function(){a.onmessage=function(){var e=arguments;t.$apply(function(){for(var t in r)r[t].apply(a,e)})}},o=function(t){r.push(t)};return{onmessage:function(t){o(t),n()}}};ResqueBoard.factory("jobsProcessedCounter",function(t){var e=new SocketListener(t,"got");return e}),ResqueBoard.factory("jobsFailedCounter",function(t){var e=new SocketListener(t,"fail");return e}),ResqueBoard.factory("jobsSuccessCounter",function(t){var e=new SocketListener(t,"done");return e}),ResqueBoard.factory("workerStartListener",function(t){var e=new SocketListener(t,"start");return e}),ResqueBoard.factory("workerStopListener",function(t){var e=new SocketListener(t,"shutdown");return e}),ResqueBoard.factory("workerPauseListener",function(t){var e=new SocketListener(t,"pause");return e}),ResqueBoard.factory("workerResumeListener",function(t){var e=new SocketListener(t,"resume");return e}),ResqueBoard.controller("LatestJobsHeatmapCtrl",["$scope","$http",function(t,e){t.jobs=[],t.loading=!1,t.date=!1,t.predicate="time";var a=new CalHeatMap;a.init({id:"latest-jobs-heatmap",scale:[10,20,30,40],itemName:["job","jobs"],range:6,cellsize:10,browsing:!0,browsingOptions:{nextLabel:'<i class="icon-chevron-right"></i>',previousLabel:'<i class="icon-chevron-left"></i>'},data:"/api/jobs/stats/{{t:start}}/{{t:end}}",onClick:function(a){t.loading=!0;var r=d3.time.format("%H:%M, %A %B %e %Y");t.date=r(a),e({method:"GET",url:"/api/jobs/"+ +a/1e3+"/"+(+a/1e3+60)}).success(function(e){t.jobs=[];for(var a in e){for(var r in e[a])e[a][r].created=new Date(1e3*e[a][r].s_time),e[a][r].args=print_r(e[a][r].args);t.jobs=e}t.loading=!1}).error(function(){})}}),t.clear=function(){t.date=!1,t.jobs=[]}}]);